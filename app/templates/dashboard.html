<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title>LabelLab</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}">

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;800&family=Inter:wght@400;600;700;900&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'], 
                        mono: ['JetBrains Mono', 'monospace'],
                        brand: ['Poppins', 'sans-serif'] 
                    },
                    colors: { 
                        bot: { bg: '#050505', card: '#0A0A0A', border: '#1E1E1E' } 
                    },
                    boxShadow: {
                        'glow': '0 0 10px rgba(255, 255, 255, 0.1)',
                        'glow-green': '0 0 10px rgba(34, 197, 94, 0.4)',
                        'glow-red': '0 0 10px rgba(239, 68, 68, 0.4)',
                        'glow-blue': '0 0 10px rgba(59, 130, 246, 0.4)',
                        'glow-gray': '0 0 10px rgba(156, 163, 175, 0.4)'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; background-image: radial-gradient(#1a1a1a 1px, transparent 1px); background-size: 40px 40px; }
        html.light body { background-color: #f3f4f6; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); }
        .rounded-xl, .rounded-lg, .rounded-md, .rounded { border-radius: 0px !important; }
        .rounded-full { border-radius: 9999px !important; } 
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #333; }
        .hidden-section { display: none !important; }
        input:focus, select:focus, textarea:focus { box-shadow: 0 0 0 1px #fff; border-color: #fff; }
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes shrink { from { width: 100%; } to { width: 0%; } }
    </style>
    <script>
        // --- GLOBAL STATE ---
        let allBatches = []; 
        let activeTab = "{{ active_tab|default('purchase') }}";
        let batchStatusMemory = {};
        try { batchStatusMemory = JSON.parse(localStorage.getItem('batchStatusMemory')) || {}; } catch(e) { batchStatusMemory = {}; }
        let isFirstLoad = true; 
        window.confirmedSessionIds = window.confirmedSessionIds || [];
        window.histCurrentPage = 1;
        window.autoCurrentPage = 1;

        if (localStorage.getItem('theme') === 'light') { document.documentElement.classList.remove('dark'); document.documentElement.classList.add('light'); } 
        else { document.documentElement.classList.add('dark'); document.documentElement.classList.remove('light'); }

        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark'); html.classList.add('light'); localStorage.setItem('theme', 'light');
                document.getElementById('icon-moon').classList.add('hidden');
                document.getElementById('icon-sun').classList.remove('hidden');
            } else {
                html.classList.add('dark'); html.classList.remove('light'); localStorage.setItem('theme', 'dark');
                document.getElementById('icon-moon').classList.remove('hidden');
                document.getElementById('icon-sun').classList.add('hidden');
            }
            updateNavUI(activeTab);
        }

        function switchTab(tabName) {
            ['view-purchase', 'view-automation', 'view-history', 'view-deposit', 'view-settings', 'view-stats', 'view-addresses'].forEach(id => { 
                const el = document.getElementById(id); if(el) el.classList.add('hidden-section'); 
            });
            const target = document.getElementById('view-' + tabName); 
            if(target) target.classList.remove('hidden-section');
            
            activeTab = tabName; 
            window.history.pushState({path: "/"+tabName}, '', "/"+tabName);

            if (tabName === 'history') { if(typeof window.loadFullHistory === 'function') window.loadFullHistory(); }
            if (tabName === 'stats') loadStats();
            if (tabName === 'addresses' && typeof loadAddressList === 'function') loadAddressList();
            if (tabName === 'automation') { if(typeof loadDropdown === 'function') loadDropdown(); if(typeof loadAutomationHistory === 'function') loadAutomationHistory(); }
            updateNavUI(tabName);
        }

        function updateNavUI(tabName) {
            const isDark = document.documentElement.classList.contains('dark');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.className = "nav-btn w-full group flex items-center gap-3 px-3 py-3 text-xs font-mono font-bold uppercase tracking-wider transition-all border border-transparent";
                if(isDark) btn.classList.add('text-gray-500', 'hover:text-white'); else btn.classList.add('text-gray-500', 'hover:text-black');
                const dot = btn.querySelector('.status-dot'); if(dot) { dot.className = "status-dot w-1.5 h-1.5 rounded-full"; dot.classList.add(isDark ? 'bg-gray-600' : 'bg-gray-400'); }
            });
            const activeBtn = document.getElementById('nav-' + tabName);
            if(activeBtn) {
                if(isDark) { activeBtn.classList.remove('text-gray-500', 'hover:text-white'); activeBtn.classList.add('bg-white', 'text-black', 'shadow-glow'); } 
                else { activeBtn.classList.remove('text-gray-500', 'hover:text-black'); activeBtn.classList.add('bg-black', 'text-white', 'shadow-glow'); }
                const dot = activeBtn.querySelector('.status-dot'); if(dot) { dot.classList.remove('bg-gray-600', 'bg-gray-400'); dot.classList.add(isDark ? 'bg-black' : 'bg-white'); }
            }
        }
        
        async function loadUserData() { try { const res = await fetch('/api/user'); const data = await res.json(); document.getElementById('wallet-balance').innerText = "$" + data.balance.toFixed(2); } catch(e) {} }

        function handleFileDisplay(input) {
            if (input.files && input.files[0]) {
                const fSpan = document.getElementById('fileName');
                if(fSpan) {
                    fSpan.innerText = input.files[0].name;
                    fSpan.classList.remove('text-green-600', 'dark:text-green-500', 'text-blue-500', 'text-red-500');
                    fSpan.classList.add('text-black', 'dark:text-white', 'font-bold');
                }
            }
        }

        async function verifyData() { 
            const fileInput = document.getElementById('csvUpload'); 
            if (!fileInput.files[0]) return; 
            const verifyBtn = document.getElementById('verifyBtn'); const originalText = verifyBtn.innerText;
            verifyBtn.innerText = "SCANNING..."; 
            const formData = new FormData(); formData.append('file', fileInput.files[0]); 
            try { 
                const res = await fetch('/verify-csv', { method: 'POST', body: formData }); 
                const data = await res.json(); 
                verifyBtn.innerText = originalText;
                if (res.ok && data.count) { 
                    showNotification(`SCAN COMPLETE: ${data.count} LABELS`, 'success'); 
                    const confirmBtn = document.getElementById('confirmBtn'); 
                    confirmBtn.disabled = false; 
                    confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-200', 'dark:bg-[#111]', 'text-gray-500');
                    confirmBtn.classList.add('bg-black', 'dark:bg-white', 'text-white', 'dark:text-black', 'shadow-glow');
                    confirmBtn.innerText = `EXECUTE ($${data.cost.toFixed(2)})`; 
                } else { showNotification("ERROR: " + (data.error || "Unknown"), 'error'); } 
            } catch (error) { showNotification("NETWORK ERROR", 'error'); verifyBtn.innerText = originalText; } 
        }

        async function handlePurchase() {
            const btn = document.getElementById('confirmBtn'); 
            const fileInput = document.getElementById('csvUpload');
            const formData = new FormData(); 
            formData.append('file', fileInput.files[0]);
            formData.append('label_type', document.querySelector('[name="label_type"]').value);
            formData.append('tracking_version', document.querySelector('[name="tracking_version"]').value);
            formData.append('template_choice', document.querySelector('[name="template_choice"]').value);
            const originalText = btn.innerText; btn.innerText = "PROCESSING...";
            const res = await fetch('/process', { method: 'POST', body: formData });
            const data = await res.json();
            if(data.status === 'success') {
                showNotification("BATCH SUBMITTED", 'queued'); 
                loadUserData(); 
                fileInput.value = ""; 
                const fSpan = document.getElementById('fileName');
                if(fSpan) {
                    fSpan.innerText = "Select .CSV File";
                    fSpan.classList.remove('text-black', 'dark:text-white', 'font-bold');
                }
                btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-200', 'dark:bg-[#111]', 'text-gray-500');
                btn.classList.remove('bg-black', 'dark:bg-white', 'text-white', 'dark:text-black', 'shadow-glow');
                btn.innerText = "EXECUTE";
            } else { showNotification("ERROR: " + data.error, 'error'); btn.innerText = originalText; }
        }

        async function loadStats() { try { const res = await fetch('/api/stats'); const data = await res.json(); document.getElementById('stat-labels').innerText = data.total_labels; document.getElementById('stat-batches').innerText = data.total_batches; } catch(e) {} }

        async function pollNotifications() {
            try {
                if (activeTab === 'history') window.loadFullHistory();
                else if (activeTab === 'automation') window.loadAutomationHistory();
                
                // --- ADMIN MESSAGES POLL ---
                const notifRes = await fetch('/api/notifications/poll');
                const notifs = await notifRes.json();
                if(notifs && notifs.length > 0) {
                    notifs.forEach(n => {
                        showNotification(n.msg, n.type === 'error' ? 'error' : 'success');
                    });
                    loadUserData();
                }

                // --- GLOBAL ALERT CHECKER ---
                const response = await fetch(`/api/batches?page=1&limit=5`);
                const result = await response.json();
                if(result.data) {
                    let hasChanges = false;
                    result.data.forEach(batch => {
                        if(batch.status === 'AUTH_ERROR' && batchStatusMemory[batch.batch_id] !== 'AUTH_ERROR') {
                            showNotification("FAILED: CHECK COOKIES/CSRF", 'error');
                        }
                        if (batchStatusMemory[batch.batch_id] !== batch.status) {
                            batchStatusMemory[batch.batch_id] = batch.status;
                            hasChanges = true;
                        }
                    });
                    if (hasChanges) localStorage.setItem('batchStatusMemory', JSON.stringify(batchStatusMemory));
                }
                
            } catch(e) {}
        }

        function showNotification(message, type = 'success') {
            const container = document.getElementById('notif-container');
            if (container.children.length >= 3) {
                container.removeChild(container.firstElementChild);
            }

            const notif = document.createElement('div');
            
            let borderColor = 'border-green-500';
            let dotColor = 'bg-green-500 shadow-glow-green';
            let barColor = '#22c55e';

            if (type === 'error') {
                borderColor = 'border-red-500'; dotColor = 'bg-red-500 shadow-glow-red'; barColor = '#ef4444';
            } else if (type === 'processing') {
                borderColor = 'border-blue-500'; dotColor = 'bg-blue-500 shadow-glow-blue'; barColor = '#3b82f6';
            } else if (type === 'queued') {
                borderColor = 'border-gray-500'; dotColor = 'bg-gray-500 shadow-glow-gray'; barColor = '#6b7280';
            }
            
            notif.className = `w-80 bg-white dark:bg-[#0A0A0A] border ${borderColor} p-4 shadow-xl mb-4 relative overflow-hidden animate-[slideIn_0.3s_ease-out]`;
            notif.innerHTML = `<div class="flex items-start gap-3 relative z-10">
                <div class="w-2 h-2 rounded-full ${dotColor} mt-1 flex-shrink-0"></div>
                <div>
                    <h4 class="text-[10px] font-bold uppercase tracking-widest text-gray-500 mb-1">SYSTEM NOTIFICATION</h4>
                    <p class="text-xs font-mono font-bold text-black dark:text-white leading-tight">${message}</p>
                </div>
            </div>
            <div class="absolute bottom-0 left-0 h-1 bg-gray-100 dark:bg-[#222] w-full">
                <div class="h-full" style="background-color: ${barColor}; animation: shrink 4s linear forwards;"></div>
            </div>`;
            
            container.appendChild(notif);
            setTimeout(() => { notif.style.animation = 'fadeOut 0.5s forwards'; setTimeout(() => notif.remove(), 500); }, 4000);
        }

        setInterval(() => { loadUserData(); pollNotifications(); }, 3000);
        window.onload = function() { loadUserData(); switchTab(activeTab); const csvIn = document.getElementById('csvUpload'); if(csvIn) { csvIn.addEventListener('change', function() { handleFileDisplay(this); }); } };
    </script>
</head>
<body class="bg-gray-100 dark:bg-bot-bg text-black dark:text-bot-text h-screen flex overflow-hidden font-sans selection:bg-black selection:text-white dark:selection:bg-white dark:selection:text-black">
    <div id="notif-container" class="fixed bottom-6 right-6 z-50 flex flex-col items-end pointer-events-none"><style>#notif-container > * { pointer-events: auto; }</style></div>
    {% include 'components/sidebar.html' %}
    <main class="flex-1 flex flex-col relative overflow-hidden">
        {% include 'components/topbar.html' %}
        <div class="flex-1 overflow-y-auto p-8">
            <div id="view-purchase" class="h-full flex items-center justify-center"> {% include 'components/modules/purchase.html' %} </div>
            
            <div id="view-history" class="hidden-section w-full max-w-6xl mx-auto flex flex-col h-full"> 
                {% include 'components/modules/history.html' %} 
                <script>
                    window.histCurrentPage = 1;
                    window.histSearchTimeout = null;

                    const searchInp = document.getElementById('historySearchInput');
                    if(searchInp) {
                        searchInp.addEventListener('input', function() {
                            clearTimeout(window.histSearchTimeout);
                            window.histSearchTimeout = setTimeout(() => { window.histCurrentPage = 1; window.loadFullHistory(); }, 500);
                        });
                    }

                    window.changeHistoryPage = function(delta) {
                        window.histCurrentPage += delta;
                        window.loadFullHistory();
                    }

                    window.loadFullHistory = async function() {
                        const targetBody = document.getElementById('history-body-content');
                        if(!targetBody) return;

                        const sVal = document.getElementById('historySearchInput') ? document.getElementById('historySearchInput').value : '';

                        try {
                            const response = await fetch(`/api/batches?page=${window.histCurrentPage}&limit=10&search=${sVal}`);
                            const result = await response.json();
                            
                            let rowHtml = '';

                            if (result.data && result.data.length > 0) {
                                result.data.forEach(batch => {
                                    let badgeTxt = '';
                                    let colorStyles = '';
                                    let isProcessing = false;
                                    let isRefunded = false;

                                    if (batch.status === 'REFUNDED') {
                                        isRefunded = true;
                                        colorStyles = 'text-red-500 border-red-500/30 bg-red-500/10';
                                        badgeTxt = 'REFUNDED';
                                    } 
                                    else if (batch.status === 'CONFIRMING') {
                                        isProcessing = true;
                                        colorStyles = 'text-blue-500 border-blue-500/30 bg-blue-500/10 animate-pulse';
                                        badgeTxt = 'CONFIRMING...';
                                    }
                                    else if (batch.status === 'AUTH_ERROR') {
                                        colorStyles = 'text-red-500 border-red-500/30 bg-red-500/10';
                                        badgeTxt = 'AUTH FAILED';
                                    }
                                    else if (batch.status === 'CONFIRM_FAILED') {
                                        colorStyles = 'text-red-500 border-red-500/30 bg-red-500/10';
                                        badgeTxt = 'CONFIRM FAIL';
                                    }
                                    else if (batch.status === 'COMPLETED' || batch.status === 'CONFIRMED') {
                                        colorStyles = 'text-green-600 dark:text-green-400 border-green-500/20 bg-green-500/5';
                                        badgeTxt = 'COMPLETED';
                                    } 
                                    else if (batch.status === 'PARTIAL') {
                                        colorStyles = 'text-yellow-600 dark:text-yellow-400 border-yellow-500/20 bg-yellow-500/5';
                                        badgeTxt = 'PARTIAL';
                                    } 
                                    else if (batch.status === 'PROCESSING') {
                                        isProcessing = true;
                                        colorStyles = 'text-blue-600 dark:text-blue-400 border-blue-500/20 bg-blue-500/5 animate-pulse';
                                        badgeTxt = 'PROCESSING...';
                                    }
                                    else if (batch.status === 'QUEUED') {
                                        isProcessing = true;
                                        colorStyles = 'text-gray-500 border-gray-300 dark:border-[#333] bg-gray-100 dark:bg-white/5';
                                        badgeTxt = 'QUEUED';
                                    }
                                    else {
                                        colorStyles = 'text-red-600 dark:text-red-400 border-red-500/20 bg-red-500/5';
                                        badgeTxt = 'FAILED';
                                    }

                                    let pdfButton = '';
                                    let csvButton = '';

                                    const safeStatus = ['CONFIRMING', 'CONFIRMED', 'AUTH_ERROR', 'CONFIRM_FAILED', 'COMPLETED', 'PARTIAL'];

                                    if (isRefunded) {
                                        pdfButton = `<span class="text-red-500/50 font-black uppercase text-[9px] leading-none cursor-not-allowed select-none">REVOKED</span>`;
                                        csvButton = `<span class="text-red-500/50 font-black uppercase text-[9px] leading-none cursor-not-allowed select-none">REVOKED</span>`;
                                    }
                                    else if (isProcessing && batch.status !== 'CONFIRMING') {
                                        // Standard processing (making labels) - Button Hidden
                                        pdfButton = `
                                            <span class="flex items-center gap-1 text-[9px] leading-none font-mono font-bold text-gray-400 dark:text-gray-600 cursor-wait select-none">
                                                <svg class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg> 
                                                WAIT
                                            </span>`;
                                        csvButton = `<span class="text-[9px] leading-none font-mono font-bold text-gray-300 dark:text-gray-700 cursor-not-allowed select-none">CSV</span>`;
                                    } 
                                    else if (batch.success_count > 0 || safeStatus.includes(batch.status)) {
                                        // Buttons ENABLED even if count is 0 (during confirming)
                                        pdfButton = `<a href="/api/download/pdf/${batch.batch_id}" class="text-blue-500 hover:text-blue-400 font-black uppercase text-[9px] leading-none transition-colors">PDF</a>`;
                                        csvButton = `<a href="/api/download/csv/${batch.batch_id}" class="text-gray-500 hover:text-black dark:hover:text-white font-black uppercase text-[9px] leading-none transition-colors">CSV</a>`;
                                    } 
                                    else {
                                        pdfButton = `<span class="text-gray-300 font-black uppercase text-[9px] leading-none cursor-not-allowed">PDF</span>`;
                                        csvButton = `<span class="text-gray-300 font-black uppercase text-[9px] leading-none cursor-not-allowed">CSV</span>`;
                                    }

                                    rowHtml += `
                                    <tr class="hover:bg-gray-50 dark:hover:bg-white/[0.02] transition-colors group">
                                        <td class="px-8 py-5">
                                            <p class="text-black dark:text-white font-bold uppercase tracking-wide text-[10px]">${batch.batch_name}</p>
                                            <p class="text-[8px] text-gray-400 font-mono mt-0.5 uppercase">ID: ${batch.batch_id}</p>
                                        </td>
                                        <td class="px-8 py-5 text-center text-gray-500 font-mono text-[9px]">${batch.date}</td>
                                        <td class="px-8 py-5 text-center">
                                            <span class="px-2.5 py-1 border rounded-sm font-bold ${colorStyles}">${batch.success_count} / ${batch.count}</span>
                                        </td>
                                        <td class="px-8 py-5 text-center text-gray-400 font-mono text-[9px] uppercase tracking-tighter">Priority V2</td>
                                        <td class="px-8 py-5 text-center">
                                            <span class="font-black uppercase tracking-widest text-[9px] ${colorStyles.split(' ')[0]}">${badgeTxt}</span>
                                        </td>
                                        <td class="px-8 py-5 text-right font-mono">
                                            <div class="flex justify-end items-center gap-3">
                                                ${pdfButton}
                                                <span class="text-gray-300 text-[9px] leading-none select-none">|</span>
                                                ${csvButton}
                                            </div>
                                        </td>
                                    </tr>`;
                                });
                            } else {
                                rowHtml = '<tr><td colspan="6" class="p-16 text-center text-gray-400 font-mono text-[10px] tracking-[0.3em] uppercase">No Transaction Data Found</td></tr>';
                            }

                            targetBody.innerHTML = rowHtml;
                            
                            const pInfo = document.getElementById('history_page_label');
                            if (pInfo) pInfo.innerText = `Secure_Page ${result.pagination.current_page} of ${result.pagination.total_pages || 1}`;
                            
                            const pBtn = document.getElementById('btnPrevHistory');
                            const nBtn = document.getElementById('btnNextHistory');
                            if (pBtn) pBtn.disabled = result.pagination.current_page <= 1;
                            if (nBtn) nBtn.disabled = result.pagination.current_page >= result.pagination.total_pages;

                        } catch(err) {
                            console.error("Critical Load Error:", err);
                            targetBody.innerHTML = '<tr><td colspan="6" class="p-16 text-center text-red-500 font-mono text-[10px] uppercase">Data Sync Failure</td></tr>';
                        }
                    }
                </script>
            </div>
            
            <div id="view-automation" class="hidden-section w-full h-full overflow-y-auto"> {% include 'components/modules/automation.html' %} </div>
            <div id="view-stats" class="hidden-section w-full h-full overflow-y-auto"> {% include 'components/modules/stats.html' %} </div>
            <div id="view-deposit" class="hidden-section w-full h-full overflow-y-auto"> {% include 'components/modules/deposit.html' %} </div>
            <div id="view-settings" class="hidden-section w-full h-full overflow-y-auto"> {% include 'components/modules/settings.html' %} </div>
            <div id="view-addresses" class="hidden-section w-full h-full overflow-y-auto"> {% include 'components/modules/addresses.html' %} </div>
        </div>
    </main>
</body>
</html>