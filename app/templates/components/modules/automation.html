<div class="w-full max-w-[1600px] mx-auto flex flex-col h-full py-6 px-6 space-y-6 animate-in fade-in duration-500">
    <div class="flex flex-col md:flex-row md:items-center justify-between border-b border-gray-200 dark:border-[#1E1E1E] pb-4 gap-4">
        <div>
            <h2 class="text-xl font-mono font-bold text-black dark:text-white uppercase tracking-wider">> Automation Console</h2>
            <div class="flex flex-col mt-1">
                <p class="text-[10px] text-gray-500 font-mono uppercase">Seller Central Integration Suite // Session Tracking Enabled</p>
                <p class="text-[9px] text-blue-500 font-mono mt-1 uppercase tracking-wider">
                    <span class="text-gray-400">* Note:</span> Confirmation window remains open for 7 days after batch creation.
                </p>
            </div>
        </div>
        
        <div class="flex gap-4 items-center">
            <div class="flex flex-col items-end px-2">
                <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest font-mono">System Status</span>
                <div class="flex items-center gap-2 text-green-500 text-[10px] font-mono font-bold uppercase">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                    {{ system_status }}
                </div>
            </div>
            
            <div class="h-8 w-[1px] bg-gray-200 dark:border-[#1E1E1E]"></div>
            
            <div class="flex gap-2">
                <div class="px-4 py-2 bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] min-w-[90px] text-center">
                    <p class="text-[8px] font-bold text-gray-500 uppercase tracking-widest font-mono mb-0.5">Monthly</p>
                    <p id="header_slots_m" class="text-[10px] font-mono font-bold text-black dark:text-white">{{ monthly_left }} LEFT</p>
                </div>
                <div class="px-4 py-2 bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] min-w-[90px] text-center">
                    <p class="text-[8px] font-bold text-gray-500 uppercase tracking-widest font-mono mb-0.5">Lifetime</p>
                    <p id="header_slots_l" class="text-[10px] font-mono font-bold text-black dark:text-white">{{ lifetime_left }} LEFT</p>
                </div>
            </div>
        </div>
    </div>

    {% if user.is_subscribed %}
    <div class="flex flex-col lg:grid lg:grid-cols-12 gap-6 flex-1 min-h-0">
        <div class="lg:col-span-4 flex flex-col gap-4 min-h-0">
            
            <div class="bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] p-5 relative overflow-hidden group shadow-glow shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-green-500/10 border border-green-500/20 text-green-500 flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-black dark:text-white uppercase tracking-widest font-mono">License Active</p>
                            <p class="text-[8px] font-mono text-gray-500 uppercase">Expires: {{ user.subscription_end }}</p>
                        </div>
                    </div>
                    <label class="flex items-center gap-2 cursor-pointer group/toggle">
                        <span class="text-[8px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest group-hover/toggle:text-black dark:group-hover/toggle:text-white transition-colors font-mono">Auto-Renew</span>
                        <input type="checkbox" id="autoRenewActive" {% if user.auto_renew %}checked{% endif %} onchange="saveSettings()" class="w-3.5 h-3.5 accent-green-500 cursor-pointer bg-gray-100 dark:bg-[#111] border-gray-300 dark:border-[#333]">
                    </label>
                </div>
            </div>

            <div class="bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] flex flex-col flex-1 relative overflow-hidden shadow-glow min-h-0">
                <div class="flex border-b border-gray-200 dark:border-[#1E1E1E] bg-gray-50 dark:bg-[#050505] shrink-0">
                    <button onclick="toggleConfigTab('credentials')" id="tab-credentials" class="flex-1 py-3 text-[9px] font-bold uppercase tracking-widest border-b-2 border-black dark:border-white text-black dark:text-white transition-all font-mono hover:bg-gray-100 dark:hover:bg-[#111]">API Keys</button>
                    <button onclick="toggleConfigTab('inventory')" id="tab-inventory" class="flex-1 py-3 text-[9px] font-bold uppercase tracking-widest text-gray-400 border-b-2 border-transparent transition-all font-mono hover:bg-gray-100 dark:hover:bg-[#111] hover:text-black dark:hover:text-white">Inventory</button>
                    <button onclick="toggleConfigTab('sender')" id="tab-sender" class="flex-1 py-3 text-[9px] font-bold uppercase tracking-widest text-gray-400 border-b-2 border-transparent transition-all font-mono hover:bg-gray-100 dark:hover:bg-[#111] hover:text-black dark:hover:text-white">Sender</button>
                </div>

                <div class="p-5 flex-1 flex flex-col min-h-0 overflow-hidden relative">
                    
                    <div id="panel-credentials" class="h-full flex flex-col space-y-4 overflow-y-auto custom-scrollbar">
                        <div>
                            <label class="text-[9px] font-bold text-gray-500 uppercase tracking-widest block mb-2 font-mono">Cookies (JSON String)</label>
                            <textarea id="in_cookies" rows="6" class="w-full p-3 bg-gray-50 dark:bg-[#050505] border border-gray-200 dark:border-[#1E1E1E] text-[10px] font-mono text-black dark:text-white outline-none resize-none focus:border-black dark:focus:border-white transition-all placeholder-gray-400">{{ user.auth_cookies or '' }}</textarea>
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-gray-500 uppercase tracking-widest block mb-2 font-mono">CSRF Token</label>
                            <input type="text" id="in_csrf" value="{{ user.auth_csrf or '' }}" class="w-full p-3 bg-gray-50 dark:bg-[#050505] border border-gray-200 dark:border-[#1E1E1E] text-[10px] font-mono text-black dark:text-white outline-none focus:border-black dark:focus:border-white transition-all placeholder-gray-400">
                        </div>
                    </div>

                    <div id="panel-inventory" class="hidden h-full flex flex-col">
                        <textarea id="in_inventory" class="hidden">{{ user.inventory_json or '{}' }}</textarea>
                        
                        <div class="bg-gray-50 dark:bg-[#050505] border border-gray-200 dark:border-[#1E1E1E] p-3 space-y-2 shrink-0 mb-3">
                            <div class="grid grid-cols-2 gap-2">
                                <input id="inv_sku" type="text" placeholder="SKU ID" class="p-2.5 bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] text-[10px] font-mono text-black dark:text-white outline-none focus:border-blue-500 placeholder-gray-400">
                                <input id="inv_weight" type="number" placeholder="Lbs" class="p-2.5 bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] text-[10px] font-mono text-black dark:text-white outline-none focus:border-blue-500 placeholder-gray-400">
                            </div>
                            <input id="inv_desc" type="text" placeholder="Package Description" class="w-full p-2.5 bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] text-[10px] font-mono text-black dark:text-white outline-none focus:border-blue-500 placeholder-gray-400">
                            <button onclick="addInvItem()" class="w-full py-2 bg-black dark:bg-white border border-transparent text-white dark:text-black text-[9px] font-bold uppercase tracking-widest hover:opacity-90 transition-all font-mono">Update Map</button>
                        </div>

                        <div id="inventory_list" class="space-y-2 flex-1 overflow-y-auto custom-scrollbar"></div>
                    </div>

                    <div id="panel-sender" class="hidden h-full flex flex-col space-y-4 overflow-y-auto custom-scrollbar">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[9px] font-bold text-gray-500 uppercase tracking-widest block font-mono">Sender Profile</label>
                            <a href="#" onclick="switchTab('addresses')" class="text-[9px] font-bold text-blue-500 uppercase hover:text-blue-400 transition-colors font-mono underline decoration-blue-500/30 underline-offset-4">Manage Profiles</a>
                        </div>
                        <select id="addr_select" onchange="handleAddrChange()" class="w-full p-3 bg-gray-50 dark:bg-[#050505] border border-gray-200 dark:border-[#1E1E1E] text-[10px] font-mono text-black dark:text-white outline-none cursor-pointer hover:bg-gray-100 dark:hover:bg-[#111] transition-all">
                            <option value="">LOADING...</option>
                        </select>
                        <div class="pt-4 border-t border-gray-200 dark:border-[#1E1E1E]">
                            <label class="text-[9px] font-bold text-gray-500 uppercase tracking-widest block mb-2 font-mono">Unshipped Data (.TXT)</label>
                            <input type="file" id="in_file" accept=".txt" class="hidden" onchange="handleFileSelect(this)">
                            <button onclick="document.getElementById('in_file').click()" class="w-full py-6 border border-dashed border-gray-300 dark:border-[#333] hover:border-black dark:hover:border-white text-[9px] font-mono text-gray-400 hover:text-black dark:hover:text-white transition-all uppercase group bg-gray-50 dark:bg-[#050505]">
                                <span id="selectedFileName">Select Amazon Report</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-5 border-t border-gray-200 dark:border-[#1E1E1E] space-y-2 bg-gray-50 dark:bg-[#050505] shrink-0">
                    <button onclick="saveSettings()" id="saveBtn" class="w-full py-3 bg-black dark:bg-white text-white dark:text-black font-bold text-[9px] uppercase tracking-widest hover:opacity-90 transition-all font-mono shadow-sm">Save Config</button>
                    <button onclick="formatFile()" id="parseBtn" disabled class="w-full py-3 bg-gray-100 dark:bg-[#151515] border border-gray-200 dark:border-[#1E1E1E] text-gray-400 text-[9px] font-bold uppercase tracking-widest cursor-not-allowed transition-all font-mono">Parse Orders</button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8 flex flex-col bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] shadow-glow overflow-hidden min-h-0">
            <div class="p-5 border-b border-gray-200 dark:border-[#1E1E1E] flex justify-between items-center bg-gray-50 dark:bg-[#050505] shrink-0">
                <div class="flex items-center gap-6">
                    <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest font-mono">Pending Confirmations</h3>
                    <div class="flex items-center gap-4 border-l border-gray-200 dark:border-[#1E1E1E] pl-6 text-center">
                        <div>
                            <p class="text-[8px] font-bold text-gray-500 uppercase tracking-widest font-mono mb-0.5">Ready</p>
                            <p id="stat-ready" class="text-[10px] font-mono font-bold text-black dark:text-white">0</p>
                        </div>
                        <div>
                            <p class="text-[8px] font-bold text-gray-500 uppercase tracking-widest font-mono mb-0.5">Partial</p>
                            <p id="stat-partial" class="text-[10px] font-mono font-bold text-yellow-500">0</p>
                        </div>
                        <div>
                            <p class="text-[8px] font-bold text-gray-500 uppercase tracking-widest font-mono mb-0.5">Failed</p>
                            <p id="stat-failed" class="text-[10px] font-mono font-bold text-red-500">0</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2 px-3 py-1.5 bg-green-500/5 border border-green-500/20">
                    <div class="w-1 h-1 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-[8px] font-mono text-green-600 dark:text-green-400 font-bold uppercase tracking-widest">Real-Time</span>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <table class="w-full text-left border-collapse min-w-[800px]">
                    <thead class="bg-white dark:bg-[#0A0A0A] sticky top-0 z-10 border-b border-gray-200 dark:border-[#1E1E1E]">
                        <tr>
                            <th class="px-6 py-4 text-[9px] font-bold text-gray-500 uppercase tracking-widest font-mono">Batch Identity</th>
                            <th class="px-6 py-4 text-[9px] font-bold text-gray-500 uppercase tracking-widest text-center font-mono">Date</th>
                            <th class="px-6 py-4 text-[9px] font-bold text-gray-500 uppercase tracking-widest text-center font-mono">Volume</th>
                            <th class="px-6 py-4 text-[9px] font-bold text-gray-500 uppercase tracking-widest text-center font-mono">Status</th>
                            <th class="px-6 py-4 text-[9px] font-bold text-gray-500 uppercase tracking-widest text-right font-mono">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="automation-history-body" class="divide-y divide-gray-100 dark:divide-[#151515] text-[10px] font-mono"></tbody>
                </table>
            </div>

            <div class="p-4 border-t border-gray-200 dark:border-[#1E1E1E] flex justify-between items-center bg-gray-50 dark:bg-[#050505] shrink-0">
                <span id="auto_page_info" class="text-[9px] font-mono font-bold text-gray-500 uppercase tracking-widest">Page 0 of 0</span>
                <div class="flex gap-2">
                    <button onclick="changeAutoPage(-1)" id="btnPrevAuto" disabled class="px-4 py-1.5 border border-gray-200 dark:border-[#1E1E1E] text-[8px] font-bold uppercase text-black dark:text-white hover:bg-white dark:hover:bg-[#151515] disabled:opacity-30 transition-all font-mono">Prev</button>
                    <button onclick="changeAutoPage(1)" id="btnNextAuto" disabled class="px-4 py-1.5 border border-gray-200 dark:border-[#1E1E1E] text-[8px] font-bold uppercase text-black dark:text-white hover:bg-white dark:hover:bg-[#151515] disabled:opacity-30 transition-all font-mono">Next</button>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <div class="flex flex-1 items-center justify-center">
        <div class="max-w-md w-full bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] p-8 shadow-glow text-center">
            <div class="w-16 h-16 bg-red-500/10 border border-red-500/20 text-red-500 flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m0 0v2m0-2h2m-2 0H10m4-11a4 4 0 11-8 0 4 4 0 018 0zM7 10h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            </div>
            <h3 class="text-xs font-black text-black dark:text-white uppercase tracking-[0.3em] mb-2 font-mono">Access Restricted</h3>
            <p class="text-[10px] text-gray-500 font-mono uppercase mb-8 leading-relaxed">Automation Suite requires an active integration license. Please select a plan below to continue.</p>
            
            <div class="grid grid-cols-1 gap-3">
                <button onclick="buyKey('monthly')" class="w-full py-4 bg-black dark:bg-white text-white dark:text-black text-[10px] font-black uppercase hover:opacity-90 transition-all font-mono shadow-sm">
                    Unlock Monthly Access $<span id="disp_price_m">{{ price_monthly }}</span>
                </button>
                <button onclick="buyKey('lifetime')" class="w-full py-4 bg-transparent border border-gray-200 dark:border-white/10 text-black dark:text-white text-[10px] font-black uppercase hover:bg-gray-100 dark:hover:bg-white/5 transition-all font-mono">
                    Unlock Lifetime Suite $<span id="disp_price_l">{{ price_lifetime }}</span>
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    let wasSubscribed = "{{ 'true' if user.is_subscribed else 'false' }}" === "true";
    let autoCurrentPage = 1;
    let fileSelected = false;
    let addressesAvailable = false;
    window.confirmedSessionIds = []; 

    async function syncConfig() {
        try {
            const res = await fetch('/api/automation/public_config');
            const data = await res.json();
            
            const elM = document.getElementById('header_slots_m');
            const elL = document.getElementById('header_slots_l');
            if(elM) elM.innerText = data.monthly_left + " LEFT";
            if(elL) elL.innerText = data.lifetime_left + " LEFT";

            const prM = document.getElementById('disp_price_m');
            const prL = document.getElementById('disp_price_l');
            if(prM) prM.innerText = data.monthly_price;
            if(prL) prL.innerText = data.lifetime_price;
        } catch(e) {}
    }
    setInterval(syncConfig, 5000);

    async function buyKey(plan) {
        showNotification(`PURCHASING ${plan.toUpperCase()} LICENSE...`, 'processing');
        try {
            const res = await fetch('/api/automation/purchase', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plan: plan })
            });
            const data = await res.json();
            if (res.ok) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification(data.error || "PURCHASE FAILED", 'error');
            }
        } catch (e) {
            showNotification("CONNECTION ERROR", "error");
        }
    }

    function toggleConfigTab(tabId) {
        ['credentials', 'inventory', 'sender'].forEach(id => {
            const p = document.getElementById(`panel-${id}`);
            const t = document.getElementById(`tab-${id}`);
            if(p && t) {
                p.classList.add('hidden');
                t.classList.remove('text-black', 'dark:text-white', 'border-black', 'dark:border-white');
                t.classList.add('text-gray-400', 'border-transparent');
            }
        });
        const p_new = document.getElementById(`panel-${tabId}`);
        const t_new = document.getElementById(`tab-${tabId}`);
        if(p_new && t_new) {
            p_new.classList.remove('hidden');
            t_new.classList.add('text-black', 'dark:text-white', 'border-black', 'dark:border-white');
            t_new.classList.remove('text-gray-400', 'border-transparent');
        }
    }

    async function loadDropdown() { const sel = document.getElementById('addr_select'); if(!sel) return; try { const res = await fetch('/api/addresses'); const data = await res.json(); if (data.length === 0) { sel.innerHTML = '<option value="">NO SAVED PROFILES</option>'; sel.disabled = true; addressesAvailable = false; } else { let opts = '<option value="" disabled>Select Sender Profile...</option>'; const savedId = localStorage.getItem('lastSelectedSender'); let foundSaved = false; data.forEach(a => { const isSelected = (savedId && String(a.id) === String(savedId)); if (isSelected) foundSaved = true; opts += `<option value="${a.id}" ${isSelected ? 'selected' : ''}>${a.name} | ${a.state}</option>`; }); sel.innerHTML = opts; sel.disabled = false; addressesAvailable = true; if (!foundSaved) sel.value = ""; } checkParseReady(); } catch(e) { sel.innerHTML = '<option>ERROR LOADING</option>'; } }
    function handleAddrChange() { const sel = document.getElementById('addr_select'); if (sel && sel.value) { localStorage.setItem('lastSelectedSender', sel.value); checkParseReady(); } }
    function renderInventory() { const raw = document.getElementById('in_inventory'); const listDiv = document.getElementById('inventory_list'); if(!raw || !listDiv) return; let data = {}; try { data = JSON.parse(raw.value); } catch(e) { data = {}; } if (Object.keys(data).length === 0) { listDiv.innerHTML = '<div class="p-3 text-center text-gray-400 italic text-[9px] font-mono uppercase tracking-widest">Inventory map empty.</div>'; return; } let html = ''; for (const [sku, details] of Object.entries(data)) { html += `<div class="flex items-center justify-between p-2.5 bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E]"><div class="flex flex-col"><span class="text-[10px] font-bold text-black dark:text-white font-mono">${sku}</span><span class="text-[8px] text-gray-500 uppercase tracking-widest font-mono">${details.weight} lbs // ${details.description}</span></div><button onclick="removeInvItem('${sku}')" class="text-red-500 hover:text-red-600 text-[8px] font-bold uppercase tracking-widest font-mono">Remove</button></div>`; } listDiv.innerHTML = html; }
    function addInvItem() { const sku = document.getElementById('inv_sku').value.trim(); const weight = document.getElementById('inv_weight').value.trim(); const desc = document.getElementById('inv_desc').value.trim(); const hiddenInput = document.getElementById('in_inventory'); if (!sku || !weight || !desc) { showNotification("MISSING FIELDS", "error"); return; } let data = {}; try { data = JSON.parse(hiddenInput.value || "{}"); } catch(e) { data = {}; } data[sku] = { "weight": parseFloat(weight), "description": desc }; hiddenInput.value = JSON.stringify(data); renderInventory(); document.getElementById('inv_sku').value = ''; document.getElementById('inv_weight').value = ''; document.getElementById('inv_desc').value = ''; showNotification(`MAPPED: ${sku}`, "success"); }
    function removeInvItem(sku) { const hiddenInput = document.getElementById('in_inventory'); let data = {}; try { data = JSON.parse(hiddenInput.value || "{}"); } catch(e) { data = {}; } if(data[sku]) { delete data[sku]; hiddenInput.value = JSON.stringify(data); renderInventory(); showNotification(`UNMAPPED: ${sku}`, "success"); } }
    async function formatFile() { const fileInput = document.getElementById('in_file'); const addrSelect = document.getElementById('addr_select'); const inventoryData = document.getElementById('in_inventory').value; if (!fileInput.files[0]) { showNotification("MISSING FILE: UPLOAD .TXT", "error"); return; } if (!addrSelect.value) { showNotification("MISSING PROFILE: SELECT SENDER", "error"); return; } const formData = new FormData(); formData.append('file', fileInput.files[0]); formData.append('address_id', addrSelect.value); formData.append('inventory', inventoryData); const btn = document.getElementById('parseBtn'); const originalText = btn.innerText; btn.innerText = "PROCESSING..."; btn.disabled = true; try { const res = await fetch('/api/automation/format', { method: 'POST', body: formData }); if (res.ok) { const blob = await res.blob(); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Parsed_Orders_${new Date().getTime()}.zip`; document.body.appendChild(a); a.click(); a.remove(); showNotification("FILE PARSED SUCCESSFULLY", 'success'); } else { const err = await res.json(); showNotification(`ERROR: ${err.error || 'BAD REQUEST'}`, 'error'); } } catch(e) { showNotification("CONNECTION FAILED", 'error'); } btn.innerText = originalText; btn.disabled = false; }
    function handleFileSelect(input) { if (input.files && input.files[0]) { const name = input.files[0].name; const span = document.getElementById('selectedFileName'); if(span) { span.innerText = name; span.classList.add('text-black', 'dark:text-white', 'font-bold'); } showNotification(name + " STAGED", 'success'); fileSelected = true; checkParseReady(); } }
    function checkParseReady() { const parseBtn = document.getElementById('parseBtn'); const addrValue = document.getElementById('addr_select') ? document.getElementById('addr_select').value : null; if (parseBtn && fileSelected && addressesAvailable && addrValue) { parseBtn.disabled = false; parseBtn.classList.remove('text-gray-400', 'cursor-not-allowed', 'bg-gray-100', 'dark:bg-[#151515]'); parseBtn.classList.add('bg-black', 'dark:bg-white', 'text-white', 'dark:text-black', 'hover:opacity-90'); } }
    async function saveSettings() { const btn = document.getElementById('saveBtn'); const original = btn.innerText; btn.innerText = "SAVING..."; const formData = new FormData(); formData.append('cookies', document.getElementById('in_cookies').value); formData.append('csrf', document.getElementById('in_csrf').value); formData.append('inventory', document.getElementById('in_inventory').value); const arActive = document.getElementById('autoRenewActive'); formData.append('auto_renew', arActive ? arActive.checked : false); try { const res = await fetch('/api/automation/save', { method: 'POST', body: formData }); if (res.ok) { showNotification("SETTINGS SAVED", 'success'); } else showNotification("SAVE FAILED", 'error'); } catch (e) { showNotification("ERROR SAVING", 'error'); } btn.innerText = original; }
    
    async function confirmOrder(batchId) { 
        showNotification('JOB STARTED - MONITORING', 'processing'); 
        try { 
            const res = await fetch('/api/automation/confirm', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ batch_id: batchId }) 
            }); 
            const data = await res.json(); 
            if (res.ok) { 
                if (!window.confirmedSessionIds.includes(batchId)) { window.confirmedSessionIds.push(batchId); } 
                if(typeof window.batchStatusMemory !== 'undefined') window.batchStatusMemory[batchId] = 'CONFIRMING';
            } else { 
                showNotification(data.error, 'error'); 
            } 
            setTimeout(loadAutomationHistory, 1000); 
        } catch(e) { 
            showNotification('FAILED TO START', 'error'); 
        } 
    }
    
    function changeAutoPage(delta) { autoCurrentPage += delta; loadAutomationHistory(); }

    async function loadAutomationHistory() {
        const tbody = document.getElementById('automation-history-body');
        if(!tbody) return; 
        window.autoCurrentPage = autoCurrentPage;

        try {
            const res = await fetch(`/api/batches?page=${autoCurrentPage}&limit=10`);
            const json = await res.json();
            let html = '';
            
            // --- UPDATED STATS FETCHING ---
            // Fetch true global counts from API instead of local counting
            const statsRes = await fetch('/api/stats');
            const stats = await statsRes.json();
            
            if (document.getElementById('stat-ready')) document.getElementById('stat-ready').innerText = stats.ready_batches || 0;
            if (document.getElementById('stat-partial')) document.getElementById('stat-partial').innerText = stats.partial_batches || 0;
            if (document.getElementById('stat-failed')) document.getElementById('stat-failed').innerText = stats.failed_batches || 0;
            
            // Update Balance if needed
            const userRes = await fetch('/api/user');
            const userData = await userRes.json();
            const balElem = document.getElementById('wallet-balance');
            if (balElem && userData.balance !== undefined) {
                const newBalance = '$' + parseFloat(userData.balance).toFixed(2);
                if (balElem.innerText !== newBalance && balElem.innerText !== '$...') {
                    balElem.innerText = newBalance;
                    balElem.classList.add('text-green-500', 'scale-110', 'glow-ping');
                    setTimeout(() => { balElem.classList.remove('text-green-500', 'scale-110', 'glow-ping'); }, 800);
                } else { balElem.innerText = newBalance; }
            }

            json.data.forEach(b => {
                let statusBadge = '', actionBtn = '', labelClass = '';
                if (b.is_expired) {
                    labelClass = 'text-gray-500 border border-gray-500/20';
                    statusBadge = '<span class="text-gray-500 font-bold font-mono uppercase text-[9px]">EXPIRED</span>';
                    actionBtn = `<button disabled class="w-[120px] py-1.5 bg-[#111] text-gray-500 font-bold uppercase text-[8px] cursor-not-allowed border border-[#222] font-mono flex items-center justify-center ml-auto">WINDOW EXPIRED</button>`;
                }
                else if (b.status === 'REFUNDED') {
                    labelClass = 'text-red-600 dark:text-red-400 border-red-500/20';
                    statusBadge = '<span class="text-red-600 dark:text-red-400 font-bold font-mono uppercase text-[9px]">REFUNDED</span>';
                    actionBtn = `<button disabled class="w-[120px] py-1.5 bg-gray-100 dark:bg-[#111] text-gray-400 font-bold uppercase text-[8px] cursor-not-allowed border border-gray-200 dark:border-[#333] font-mono flex items-center justify-center ml-auto">REVOKED</button>`;
                }
                else if (b.status === 'CONFIRMED') {
                    labelClass = 'text-green-600 dark:text-green-400 border-green-500/30';
                    statusBadge = '<span class="text-green-600 dark:text-green-400 font-bold font-mono uppercase text-[9px]">CONFIRMED</span>';
                    actionBtn = `
                    <button onclick="confirmOrder('${b.batch_id}')" class="w-[120px] py-1.5 bg-gray-100 dark:bg-[#111] text-green-600 dark:text-green-400 font-bold uppercase text-[8px] border border-green-500/20 font-mono transition-all hover:bg-red-500 hover:text-white hover:border-red-500 group/retry flex items-center justify-center ml-auto">
                        <span class="group-hover/retry:hidden">ALREADY CONFIRMED</span>
                        <span class="hidden group-hover/retry:inline">FORCE RETRY</span>
                    </button>`;
                }
                else if (b.status === 'PROCESSING') {
                    labelClass = 'text-blue-600 dark:text-blue-400 border-blue-500/30';
                    statusBadge = '<span class="text-blue-600 dark:text-blue-400 font-bold font-mono animate-pulse uppercase text-[9px]">PROCESSING...</span>';
                    actionBtn = `<div class="w-[120px] text-center ml-auto"><span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest font-mono">SYNCING...</span></div>`;
                }
                else if (b.status === 'CONFIRMING') {
                    labelClass = 'text-blue-500 border-blue-500/30';
                    statusBadge = '<span class="text-blue-500 font-bold font-mono animate-pulse uppercase text-[9px]">CONFIRMING...</span>';
                    actionBtn = `<div class="w-[120px] text-center ml-auto"><span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest font-mono">SYNCING...</span></div>`;
                }
                else if (b.status === 'COMPLETED' || b.status === 'READY') {
                    labelClass = 'text-green-600 dark:text-green-400 border border-gray-500/20';
                    statusBadge = '<span class="text-green-600 dark:text-green-400 font-bold font-mono uppercase text-[9px]">READY</span>';
                    actionBtn = `<button onclick="confirmOrder('${b.batch_id}')" class="w-[120px] py-1.5 bg-black dark:bg-white text-white dark:text-black font-bold uppercase text-[8px] hover:opacity-80 transition-all shadow-sm rounded font-mono flex items-center justify-center ml-auto">CONFIRM BATCH</button>`;
                } 
                else if (b.status === 'PARTIAL') {
                    labelClass = 'text-yellow-600 dark:text-yellow-400 border-yellow-500/30';
                    statusBadge = '<span class="text-yellow-600 dark:text-yellow-400 font-bold font-mono uppercase text-[9px]">PARTIAL</span>';
                    actionBtn = `<button onclick="confirmOrder('${b.batch_id}')" class="w-[120px] py-1.5 bg-black dark:bg-white text-white dark:text-black font-bold uppercase text-[8px] hover:opacity-80 transition-all shadow-sm rounded font-mono flex items-center justify-center ml-auto">CONFIRM REMAINING</button>`;
                }
                else {
                    labelClass = 'text-red-600 dark:text-red-400 border-red-500/20';
                    statusBadge = `<span class="text-red-600 dark:text-red-400 font-bold font-mono uppercase text-[9px]">${b.status}</span>`;
                    actionBtn = `<button onclick="confirmOrder('${b.batch_id}')" class="w-[120px] py-1.5 border border-red-500/20 text-red-500 font-bold uppercase text-[8px] hover:bg-red-500/10 transition-all font-mono flex items-center justify-center ml-auto">RETRY</button>`;
                }

                html += `
                <tr class="hover:bg-gray-50 dark:hover:bg-[#0A0A0A] transition-colors group border-b border-gray-100 dark:border-[#151515] last:border-0">
                    <td class="px-6 py-3">
                        <p class="text-black dark:text-white font-bold font-mono uppercase tracking-wide text-[10px]">${b.batch_name}</p>
                        <p class="text-[8px] text-gray-400 font-mono mt-0.5 tracking-widest">ID: ${b.batch_id}</p>
                    </td>
                    <td class="px-6 py-3 text-center text-gray-500 font-mono text-[9px] tracking-wide">${b.date}</td>
                    <td class="px-6 py-3 text-center">
                        <span class="px-2 py-0.5 border ${labelClass} text-[9px] font-mono font-bold">${b.success_count} / ${b.count}</span>
                    </td>
                    <td class="px-6 py-3 text-center">${statusBadge}</td>
                    <td class="px-6 py-3 text-right">${actionBtn}</td>
                </tr>`;
            });
            tbody.innerHTML = html || '<tr><td colspan="5" class="p-8 text-center text-gray-400 font-mono text-[9px] tracking-[0.2em] uppercase">NO DATA FOUND</td></tr>';
            
            const meta = json.pagination;
            document.getElementById('auto_page_info').innerText = `PAGE ${meta.current_page} OF ${meta.total_pages || 1}`;
            document.getElementById('btnPrevAuto').disabled = meta.current_page <= 1;
            document.getElementById('btnNextAuto').disabled = meta.current_page >= meta.total_pages;
        } catch(e) {}
    }
    
    if(wasSubscribed) { 
        loadAutomationHistory(); 
        loadDropdown(); 
        renderInventory();
        setInterval(loadAutomationHistory, 3000); 
    }
</script>

<style>
@keyframes glowPing {
    0% { filter: drop-shadow(0 0 0px rgba(34, 197, 94, 0)); }
    50% { filter: drop-shadow(0 0 10px rgba(34, 197, 94, 0.8)); }
    100% { filter: drop-shadow(0 0 0px rgba(34, 197, 94, 0)); }
}
.glow-ping {
    animation: glowPing 0.8s ease-in-out;
    text-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
}
</style>