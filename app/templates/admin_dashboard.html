<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Admin Console</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;600;800&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'], 
                        mono: ['JetBrains Mono', 'monospace'],
                        brand: ['Poppins', 'sans-serif'] 
                    },
                    colors: { 
                        bot: { bg: '#050505', card: '#0A0A0A', border: '#1E1E1E' } 
                    },
                    boxShadow: {
                        'glow': '0 0 10px rgba(255, 255, 255, 0.1)',
                        'glow-green': '0 0 10px rgba(34, 197, 94, 0.4)',
                        'glow-red': '0 0 10px rgba(239, 68, 68, 0.4)',
                        'glow-blue': '0 0 10px rgba(59, 130, 246, 0.4)',
                        'glow-gray': '0 0 10px rgba(156, 163, 175, 0.4)'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; background-image: radial-gradient(#1a1a1a 1px, transparent 1px); background-size: 40px 40px; }
        html.light body { background-color: #f3f4f6; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); }
        .rounded-xl, .rounded-lg, .rounded-md, .rounded { border-radius: 0px !important; }
        
        ::-webkit-scrollbar { width: 6px; } 
        ::-webkit-scrollbar-track { background: transparent; } 
        ::-webkit-scrollbar-thumb { background: #333; }
        
        .hidden-section { display: none !important; }
        
        /* Tab Active State */
        .tab-btn { border-bottom: 2px solid transparent; opacity: 0.6; transition: all 0.2s; }
        .tab-btn:hover { opacity: 1; background-color: rgba(255,255,255,0.05); }
        html.light .tab-btn:hover { background-color: rgba(0,0,0,0.05); }
        
        .tab-btn.active { opacity: 1; border-bottom-color: currentColor; }
        
        input:focus, select:focus { outline: 1px solid currentColor; }

        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes shrink { from { width: 100%; } to { width: 0%; } }
    </style>
    <script>
        if (localStorage.getItem('theme') === 'light') { 
            document.documentElement.classList.remove('dark'); 
            document.documentElement.classList.add('light'); 
        } else { 
            document.documentElement.classList.add('dark'); 
            document.documentElement.classList.remove('light'); 
        }

        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark'); html.classList.add('light'); localStorage.setItem('theme', 'light');
                document.getElementById('icon-moon').classList.add('hidden');
                document.getElementById('icon-sun').classList.remove('hidden');
            } else {
                html.classList.add('dark'); html.classList.remove('light'); localStorage.setItem('theme', 'dark');
                document.getElementById('icon-moon').classList.remove('hidden');
                document.getElementById('icon-sun').classList.add('hidden');
            }
        }
    </script>
</head>
<body class="h-screen flex flex-col overflow-hidden text-black dark:text-white font-sans selection:bg-black selection:text-white dark:selection:bg-white dark:selection:text-black">

    <div id="notif-container" class="fixed bottom-6 right-6 z-[9999] flex flex-col items-end pointer-events-none"><style>#notif-container > * { pointer-events: auto; }</style></div>

    <header class="h-16 bg-white dark:bg-[#0A0A0A] border-b border-gray-200 dark:border-[#1E1E1E] flex justify-between items-center px-6 z-30 shadow-sm relative">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-semibold tracking-tight text-black dark:text-white select-none" style="font-family: 'Poppins', sans-serif;">LabelLab</h1>
            <span class="px-2 py-0.5 bg-gray-100 dark:bg-white/10 border border-gray-200 dark:border-white/20 text-[9px] font-bold uppercase tracking-widest text-gray-500 dark:text-gray-300 rounded-sm select-none">ADMIN</span>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="hidden md:flex flex-col items-end mr-2">
                <span class="text-[8px] font-bold text-gray-400 uppercase tracking-widest font-mono">Worker Latency</span>
                <div class="flex items-center gap-2">
                    <div id="hb-dot" class="w-1.5 h-1.5 rounded-full bg-red-500"></div>
                    <span class="text-[10px] font-mono font-bold" id="hb-display">OFFLINE</span>
                </div>
            </div>

            <button onclick="toggleTheme()" class="p-2 text-gray-400 hover:text-black dark:hover:text-white transition-colors">
                <svg id="icon-sun" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="icon-moon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>

            <a href="{{ url_for('main.logout') }}" class="text-[10px] font-bold text-red-500 hover:text-white hover:bg-red-500 border border-red-500/30 px-3 py-1.5 transition-all font-mono uppercase">LOGOUT</a>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-64 bg-gray-50 dark:bg-black border-r border-gray-200 dark:border-[#1E1E1E] flex flex-col p-4 gap-3 overflow-y-auto hidden md:flex">
            
            <div class="p-4 bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] shadow-sm relative overflow-hidden group">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest font-mono">Worker Node</p>
                    <div id="worker-pulse" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                </div>
                <div class="flex justify-between items-end">
                    <span id="worker-state" class="text-lg font-bold font-mono">ONLINE</span>
                    <button id="btn-pause" onclick="toggleWorker()" class="text-[9px] font-bold uppercase border border-gray-300 dark:border-[#333] hover:bg-black hover:text-white dark:hover:bg-white dark:hover:text-black px-2 py-1 transition-all">PAUSE</button>
                </div>
            </div>

            <div class="p-4 bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] shadow-sm">
                <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1 font-mono">Queue Depth</p>
                <span id="queue-count" class="text-2xl font-bold font-mono">0</span>
            </div>

            <div class="p-4 bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] shadow-sm">
                <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1 font-mono">Lifetime Revenue</p>
                <span id="rev-life" class="text-xl font-bold text-purple-600 dark:text-purple-500 font-mono">$0.00</span>
            </div>

            <div class="p-4 bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] shadow-sm">
                <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1 font-mono">30D Revenue</p>
                <span id="rev-30d" class="text-lg font-bold text-green-600 dark:text-green-500 font-mono">$0.00</span>
            </div>

            <div class="p-4 bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] shadow-sm">
                <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1 font-mono">Est. Next 30D</p>
                <span id="rev-est-30d" class="text-lg font-bold text-blue-500 font-mono">$0.00</span>
                <p class="text-[8px] text-gray-400 mt-1 uppercase font-mono">7-Day Trend</p>
            </div>

            <div class="p-4 bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] shadow-sm">
                <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1 font-mono">Monthly Sub Rev</p>
                <span id="subs-mrr" class="text-lg font-bold text-yellow-600 dark:text-yellow-500 font-mono">$0.00</span>
                <p class="text-[8px] text-gray-400 mt-1 uppercase font-mono"><span id="subs-count" class="text-black dark:text-white font-bold">0</span> Active Licenses</p>
            </div>

            <div class="p-4 bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] shadow-sm">
                <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1 font-mono">Errors (24h)</p>
                <span id="error-count" class="text-xl font-bold text-red-500 font-mono">0</span>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-gray-50 dark:bg-[#050505] min-w-0">
            <div class="flex border-b border-gray-200 dark:border-[#1E1E1E] bg-white dark:bg-[#0A0A0A] px-4 overflow-x-auto gap-4">
                <button onclick="switchTab('queue')" id="btn-queue" class="tab-btn active py-4 text-[10px] font-bold uppercase tracking-widest text-black dark:text-white border-black dark:border-white">Queue</button>
                <button onclick="switchTab('confirming')" id="btn-confirming" class="tab-btn py-4 text-[10px] font-bold uppercase tracking-widest text-gray-400">Confirming</button>
                <button onclick="switchTab('history')" id="btn-history" class="tab-btn py-4 text-[10px] font-bold uppercase tracking-widest text-gray-400">History</button>
                <button onclick="switchTab('tracking')" id="btn-tracking" class="tab-btn py-4 text-[10px] font-bold uppercase tracking-widest text-gray-400">Tracking</button>
                <button onclick="switchTab('users')" id="btn-users" class="tab-btn py-4 text-[10px] font-bold uppercase tracking-widest text-gray-400">Users</button>
                <button onclick="switchTab('server_errors')" id="btn-server_errors" class="tab-btn py-4 text-[10px] font-bold uppercase tracking-widest text-gray-400">Errors</button>
                <button onclick="switchTab('logs')" id="btn-logs" class="tab-btn py-4 text-[10px] font-bold uppercase tracking-widest text-gray-400">Audit</button>
                <button onclick="switchTab('autoconfig')" id="btn-autoconfig" class="tab-btn py-4 text-[10px] font-bold uppercase tracking-widest text-gray-400">Config</button>
                <button onclick="switchTab('versioning')" id="btn-versioning" class="tab-btn py-4 text-[10px] font-bold uppercase tracking-widest text-purple-500 border-purple-500">Versions</button>
            </div>

            <div class="flex-1 relative overflow-hidden">
                
                <div id="tab-queue-content" class="absolute inset-0 flex flex-col p-6 overflow-auto">
                    <table class="w-full text-left text-[10px] border border-gray-200 dark:border-[#1E1E1E]">
                        <thead class="bg-gray-100 dark:bg-[#111] text-gray-500 font-mono sticky top-0">
                            <tr><th class="p-4">BATCH ID</th><th class="p-4">USER</th><th class="p-4">DATE</th><th class="p-4 text-center">SIZE</th><th class="p-4 text-center">STATUS</th></tr>
                        </thead>
                        <tbody id="live-queue-body" class="divide-y divide-gray-100 dark:divide-[#1E1E1E] bg-white dark:bg-[#0A0A0A] text-gray-700 dark:text-gray-300 font-mono"></tbody>
                    </table>
                </div>

                <div id="tab-confirming-content" class="hidden-section absolute inset-0 flex flex-col p-6 overflow-auto">
                    <table class="w-full text-left text-[10px] border border-gray-200 dark:border-[#1E1E1E]">
                        <thead class="bg-gray-100 dark:bg-[#111] text-gray-500 font-mono sticky top-0">
                            <tr><th class="p-4">BATCH ID</th><th class="p-4">USER</th><th class="p-4">DATE</th><th class="p-4 text-center">PROGRESS</th><th class="p-4 text-center">STATUS</th></tr>
                        </thead>
                        <tbody id="live-confirming-body" class="divide-y divide-gray-100 dark:divide-[#1E1E1E] bg-white dark:bg-[#0A0A0A] text-gray-700 dark:text-gray-300 font-mono"></tbody>
                    </table>
                </div>

                <div id="tab-history-content" class="hidden-section absolute inset-0 flex flex-col p-6 overflow-hidden">
                    <div class="flex justify-between mb-4">
                        <input type="text" id="hist-search" onkeypress="if(event.key==='Enter') fetchHistory()" class="bg-white dark:bg-black border border-gray-200 dark:border-[#333] p-2 text-xs text-black dark:text-white w-64 focus:border-black dark:focus:border-white outline-none font-mono" placeholder="Search Batch ID...">
                    </div>
                    <div class="flex-1 overflow-auto border border-gray-200 dark:border-[#1E1E1E]">
                        <table class="w-full text-left text-[10px]">
                            <thead class="bg-gray-100 dark:bg-[#111] text-gray-500 font-mono sticky top-0">
                                <tr>
                                    <th class="p-4 font-normal">BATCH ID</th><th class="p-4 font-normal">USERNAME</th><th class="p-4 font-normal">DATE (UTC)</th><th class="p-4 font-normal text-center">SIZE</th><th class="p-4 font-normal text-center">VALUE</th><th class="p-4 font-normal text-center">STATUS</th><th class="p-4 font-normal text-right">ACTION</th>
                                </tr>
                            </thead>
                            <tbody id="history-body" class="divide-y divide-gray-100 dark:divide-[#1E1E1E] bg-white dark:bg-[#0A0A0A] text-gray-700 dark:text-gray-300 font-mono"></tbody>
                        </table>
                    </div>
                    <div class="flex justify-between items-center pt-4">
                        <span id="hist-page-info" class="text-[9px] text-gray-400 uppercase font-bold font-mono">PAGE 1</span>
                        <div class="flex gap-2">
                            <button onclick="changeHistPage(-1)" class="px-4 py-2 border border-gray-200 dark:border-[#333] bg-white dark:bg-black hover:bg-gray-100 dark:hover:bg-[#111] text-[9px] uppercase font-bold transition-all">PREV</button>
                            <button onclick="changeHistPage(1)" class="px-4 py-2 border border-gray-200 dark:border-[#333] bg-white dark:bg-black hover:bg-gray-100 dark:hover:bg-[#111] text-[9px] uppercase font-bold transition-all">NEXT</button>
                        </div>
                    </div>
                </div>

                <div id="tab-tracking-content" class="hidden-section absolute inset-0 flex flex-col p-6 overflow-hidden">
                    <div class="flex justify-between items-center border border-gray-200 dark:border-[#1E1E1E] bg-white dark:bg-[#0A0A0A] p-4 mb-4">
                        <div class="flex items-center gap-4 w-full max-w-lg">
                            <input type="text" id="track-search" onkeypress="if(event.key==='Enter') fetchTracking()" class="flex-1 bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] p-2 text-xs outline-none font-mono" placeholder="Search Tracking ID or Username...">
                        </div>
                        <div class="flex items-center gap-2">
                            <select id="track-prefix" onchange="fetchTracking()" class="bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] p-2 text-xs outline-none font-mono">
                                <option value="all">All Carriers</option>
                                <option value="95055">95055</option>
                                <option value="94888">94888</option>
                                <option value="94019">94019</option>
                                <option value="95888">95888</option>
                                <option value="91149">91149</option>
                                <option value="93055">93055</option>
                            </select>
                            
                            <div class="w-[1px] h-6 bg-gray-200 dark:bg-[#333] mx-1"></div>
                            
                            <select id="export-days" class="bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] p-2 text-xs outline-none font-mono">
                                <option value="1">Last 24 Hours</option>
                                <option value="7">Last 7 Days</option>
                                <option value="30">Last 30 Days</option>
                            </select>
                            <button onclick="exportCsv()" class="px-4 py-2 bg-black dark:bg-white text-white dark:text-black text-[9px] font-bold uppercase font-mono">EXPORT CSV</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto border border-gray-200 dark:border-[#1E1E1E]">
                        <table class="w-full text-left text-[10px]">
                            <thead class="bg-gray-100 dark:bg-[#111] text-gray-500 font-mono sticky top-0">
                                <tr>
                                    <th class="p-4 font-normal">TRACKING ID</th><th class="p-4 font-normal">USERNAME</th><th class="p-4 font-normal text-right">DATE GENERATED</th>
                                </tr>
                            </thead>
                            <tbody id="tracking-body" class="divide-y divide-gray-100 dark:divide-[#1E1E1E] bg-white dark:bg-[#0A0A0A] text-gray-700 dark:text-gray-300 font-mono"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-users-content" class="hidden-section absolute inset-0 flex flex-col p-6 overflow-hidden">
                    <div class="flex flex-col md:flex-row gap-6 h-full">
                        <div class="w-full md:w-1/3 flex flex-col border border-gray-200 dark:border-[#1E1E1E] bg-white dark:bg-[#0A0A0A]">
                            <div class="p-4 border-b border-gray-200 dark:border-[#1E1E1E] bg-gray-50 dark:bg-[#080808] flex justify-between items-center">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest font-mono">User Directory</h3>
                                <div class="px-2 py-1 bg-blue-500/10 border border-blue-500/20 text-[9px] text-blue-500 font-bold">
                                    TOTAL: <span id="total-users-count">--</span>
                                </div>
                            </div>
                            <div class="p-4 border-b border-gray-200 dark:border-[#1E1E1E]">
                                <input type="text" id="user-search" oninput="searchUsers()" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] p-2 text-xs outline-none font-mono" placeholder="Filter users...">
                            </div>
                            <div id="user-list-container" class="flex-1 overflow-y-auto custom-scrollbar">
                                <div class="p-4 text-center text-gray-500 text-[10px]">LOADING...</div>
                            </div>
                        </div>
                        <div class="flex-1 border border-gray-200 dark:border-[#1E1E1E] bg-white dark:bg-[#0A0A0A] flex flex-col relative overflow-hidden">
                            <div id="user-details-empty" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                                <span class="text-[10px] uppercase tracking-widest font-mono">Select a user to manage</span>
                            </div>
                            <div id="user-details-content" class="hidden flex-col h-full overflow-y-auto">
                                <div class="p-8 border-b border-gray-200 dark:border-[#1E1E1E] bg-gray-50 dark:bg-[#080808]">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h2 id="sel-username" class="text-3xl font-bold mb-2"></h2>
                                            <div class="flex gap-4 text-[10px] text-gray-500 font-mono uppercase tracking-wide">
                                                <span>IP: <span id="sel-ip" class="text-black dark:text-gray-300"></span></span>
                                                <span>SUB: <span id="sel-sub-status"></span></span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-[9px] text-gray-400 uppercase tracking-widest mb-1 font-mono">Current Balance</p>
                                            <p id="sel-balance" class="text-4xl font-bold text-green-600 dark:text-green-500 font-mono">$0.00</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div class="border border-gray-200 dark:border-[#1E1E1E] p-5">
                                        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4 font-mono">Wallet Operations</h3>
                                        <div class="flex gap-2 mb-2">
                                            <input type="number" id="balance-adj-amount" placeholder="0.00" class="flex-1 bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] p-2 text-xs outline-none font-mono">
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <button onclick="promptReasonAndExec('update_balance', {amount: 1}, 'Enter Reason for Balance Addition')" class="bg-green-500/10 border border-green-500/20 text-green-600 dark:text-green-500 hover:bg-green-500 hover:text-white py-2 text-[9px] font-bold uppercase transition-all font-mono">Add Funds</button>
                                            <button onclick="promptReasonAndExec('update_balance', {amount: -1}, 'Enter Reason for Deduction')" class="bg-red-500/10 border border-red-500/20 text-red-600 dark:text-red-500 hover:bg-red-500 hover:text-white py-2 text-[9px] font-bold uppercase transition-all font-mono">Deduct</button>
                                        </div>
                                    </div>
                                    
                                    <div class="border border-gray-200 dark:border-[#1E1E1E] p-5">
                                        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4 font-mono">Pricing Strategy</h3>
                                        
                                        <div class="flex items-center gap-2 mb-3">
                                            <span class="w-16 text-[9px] text-gray-500 uppercase font-mono">95055</span>
                                            <input type="number" id="price-priority-95055" step="0.01" class="flex-1 bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] p-1.5 text-xs outline-none font-mono" placeholder="0.00">
                                            <button onclick="userAction('update_price', {type:'priority', version:'95055'})" class="bg-black dark:bg-white text-white dark:text-black px-2 text-[9px] font-bold uppercase font-mono">SET</button>
                                        </div>

                                        <div class="flex items-center gap-2 mb-3">
                                            <span class="w-16 text-[9px] text-gray-500 uppercase font-mono">94888</span>
                                            <input type="number" id="price-priority-94888" step="0.01" class="flex-1 bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] p-1.5 text-xs outline-none font-mono" placeholder="0.00">
                                            <button onclick="userAction('update_price', {type:'priority', version:'94888'})" class="bg-black dark:bg-white text-white dark:text-black px-2 text-[9px] font-bold uppercase font-mono">SET</button>
                                        </div>

                                        <div class="flex items-center gap-2 mb-3">
                                            <span class="w-16 text-[9px] text-gray-500 uppercase font-mono">94019 (Test)</span>
                                            <input type="number" id="price-priority-94019" step="0.01" class="flex-1 bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] p-1.5 text-xs outline-none font-mono" placeholder="0.00">
                                            <button onclick="userAction('update_price', {type:'priority', version:'94019'})" class="bg-black dark:bg-white text-white dark:text-black px-2 text-[9px] font-bold uppercase font-mono">SET</button>
                                        </div>

                                        <div class="flex items-center gap-2 mb-3">
                                            <span class="w-16 text-[9px] text-gray-500 uppercase font-mono">95888 (Test)</span>
                                            <input type="number" id="price-priority-95888" step="0.01" class="flex-1 bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] p-1.5 text-xs outline-none font-mono" placeholder="0.00">
                                            <button onclick="userAction('update_price', {type:'priority', version:'95888'})" class="bg-black dark:bg-white text-white dark:text-black px-2 text-[9px] font-bold uppercase font-mono">SET</button>
                                        </div>

                                        <div class="flex items-center gap-2 mb-3">
                                            <span class="w-16 text-[9px] text-gray-500 uppercase font-mono">91149 (Test)</span>
                                            <input type="number" id="price-priority-91149" step="0.01" class="flex-1 bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] p-1.5 text-xs outline-none font-mono" placeholder="0.00">
                                            <button onclick="userAction('update_price', {type:'priority', version:'91149'})" class="bg-black dark:bg-white text-white dark:text-black px-2 text-[9px] font-bold uppercase font-mono">SET</button>
                                        </div>

                                        <div class="flex items-center gap-2">
                                            <span class="w-16 text-[9px] text-gray-500 uppercase font-mono">93055 (Test)</span>
                                            <input type="number" id="price-priority-93055" step="0.01" class="flex-1 bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] p-1.5 text-xs outline-none font-mono" placeholder="0.00">
                                            <button onclick="userAction('update_price', {type:'priority', version:'93055'})" class="bg-black dark:bg-white text-white dark:text-black px-2 text-[9px] font-bold uppercase font-mono">SET</button>
                                        </div>
                                    </div>

                                    <div class="border border-gray-200 dark:border-[#1E1E1E] p-5">
                                        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4 font-mono">Security</h3>
                                        <button onclick="promptReasonAndExec('reset_pass', {}, 'Enter New Password', true)" class="w-full border border-gray-200 dark:border-[#333] text-gray-500 hover:text-black dark:hover:text-white hover:border-black dark:hover:border-white py-3 text-[9px] font-bold uppercase transition-all font-mono">Reset Password</button>
                                    </div>
                                    <div class="border border-gray-200 dark:border-[#1E1E1E] p-5">
                                        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4 font-mono">Automation License</h3>
                                        <div class="space-y-2">
                                            <button onclick="promptReasonAndExec('grant_sub', {}, 'Enter Days of Access (e.g. 30)', true)" class="w-full bg-blue-600 text-white py-3 text-[9px] font-bold uppercase hover:bg-blue-500 font-mono transition-all">Grant Access</button>
                                            <button id="btn-revoke-sub" onclick="openConfirm('REVOKE LICENSE', 'Are you sure you want to revoke this user\'s license?', () => userAction('revoke_sub'))" class="w-full border border-red-500/30 text-red-500 hover:bg-red-500/10 py-3 text-[9px] font-bold uppercase hidden font-mono transition-all">Revoke License</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-server_errors-content" class="hidden-section absolute inset-0 flex flex-col p-6 overflow-auto">
                    <table class="w-full text-left text-[10px] border border-gray-200 dark:border-[#1E1E1E]">
                        <thead class="bg-gray-100 dark:bg-[#111] text-gray-500 font-mono sticky top-0">
                            <tr>
                                <th class="p-4 font-normal">TIMESTAMP</th>
                                <th class="p-4 font-normal">SOURCE</th>
                                <th class="p-4 font-normal">BATCH</th>
                                <th class="p-4 font-normal">ERROR MESSAGE</th>
                            </tr>
                        </thead>
                        <tbody id="server-errors-body" class="divide-y divide-gray-100 dark:divide-[#1E1E1E] bg-white dark:bg-[#0A0A0A] text-gray-700 dark:text-gray-300 font-mono"></tbody>
                    </table>
                </div>

                <div id="tab-logs-content" class="hidden-section absolute inset-0 flex flex-col p-6 overflow-hidden">
                    <div class="flex-1 overflow-auto border border-gray-200 dark:border-[#1E1E1E]">
                        <table class="w-full text-left text-[10px]">
                            <thead class="bg-gray-100 dark:bg-[#111] text-gray-500 font-mono sticky top-0">
                                <tr><th class="p-4">TIMESTAMP (UTC)</th><th class="p-4">ACTION</th><th class="p-4">DETAILS</th></tr>
                            </thead>
                            <tbody id="logs-body" class="divide-y divide-gray-100 dark:divide-[#1E1E1E] bg-white dark:bg-[#0A0A0A] text-gray-700 dark:text-gray-300 font-mono"></tbody>
                        </table>
                    </div>
                    
                    <div class="p-4 border-t border-gray-200 dark:border-[#1E1E1E] bg-white dark:bg-[#0A0A0A] flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <span id="logs-page-info" class="text-[9px] text-gray-400 uppercase font-bold font-mono">Page 1</span>
                            <select id="logs-limit" onchange="resetLogs()" class="bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] p-1 text-[9px] outline-none font-mono">
                                <option value="25">25 rows</option>
                                <option value="50">50 rows</option>
                                <option value="100" selected>100 rows</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="changeLogPage(-1)" class="px-4 py-2 border border-gray-200 dark:border-[#333] hover:bg-gray-100 dark:hover:bg-[#111] text-[9px] uppercase font-bold transition-all">PREV</button>
                            <button onclick="changeLogPage(1)" class="px-4 py-2 border border-gray-200 dark:border-[#333] hover:bg-gray-100 dark:hover:bg-[#111] text-[9px] uppercase font-bold transition-all">NEXT</button>
                        </div>
                    </div>
                </div>

                <div id="tab-autoconfig-content" class="hidden-section absolute inset-0 flex items-center justify-center p-6">
                    <div class="w-full max-w-lg bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] p-8 shadow-sm">
                        <h3 class="text-sm font-bold text-black dark:text-white uppercase tracking-widest mb-6 font-mono">Automation Configuration</h3>
                        <div class="grid grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="text-[9px] text-gray-500 uppercase tracking-widest block mb-2 font-mono">Monthly Price ($)</label>
                                <input type="number" id="cfg_price_monthly" class="w-full p-3 bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] font-mono text-sm focus:border-black dark:focus:border-white outline-none">
                            </div>
                            <div>
                                <label class="text-[9px] text-gray-500 uppercase tracking-widest block mb-2 font-mono">Lifetime Price ($)</label>
                                <input type="number" id="cfg_price_lifetime" class="w-full p-3 bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] font-mono text-sm focus:border-black dark:focus:border-white outline-none">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-6 mb-8">
                            <div>
                                <label class="text-[9px] text-gray-500 uppercase tracking-widest block mb-2 font-mono">Total Monthly Slots</label>
                                <input type="number" id="cfg_slots_monthly" class="w-full p-3 bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] font-mono text-sm focus:border-black dark:focus:border-white outline-none">
                            </div>
                            <div>
                                <label class="text-[9px] text-gray-500 uppercase tracking-widest block mb-2 font-mono">Total Lifetime Slots</label>
                                <input type="number" id="cfg_slots_lifetime" class="w-full p-3 bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] font-mono text-sm focus:border-black dark:focus:border-white outline-none">
                            </div>
                        </div>
                        <button onclick="saveAutoConfig()" class="w-full py-4 bg-black dark:bg-white text-white dark:text-black hover:opacity-90 font-bold uppercase tracking-widest text-xs transition-all font-mono">Update System Config</button>
                    </div>
                </div>

                <div id="tab-versioning-content" class="hidden-section absolute inset-0 flex flex-col p-8 overflow-auto">
                    <div class="mb-6 border-b border-gray-200 dark:border-[#1E1E1E] pb-4">
                        <h2 class="text-xl font-mono font-bold text-black dark:text-white uppercase tracking-wider">> Version Control Matrix</h2>
                        <p class="text-[10px] text-gray-500 font-mono mt-1 uppercase">Global Service availability & Base Pricing</p>
                    </div>

                    <div id="version-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        </div>
                </div>

            </div>
        </main>
    </div>

    <div id="custom-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] p-6 w-full max-w-md shadow-2xl animate-[slideIn_0.2s_ease-out]">
            <h3 id="modal-title" class="text-sm font-bold text-black dark:text-white uppercase tracking-widest font-mono mb-4">CONFIRM ACTION</h3>
            <p id="modal-desc" class="text-xs text-gray-500 font-mono mb-6">Are you sure you want to proceed?</p>
            <input type="text" id="modal-input" class="w-full p-3 bg-gray-50 dark:bg-black border border-gray-200 dark:border-[#333] font-mono text-xs mb-6 focus:border-black dark:focus:border-white outline-none hidden" placeholder="Enter value...">
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 border border-gray-200 dark:border-[#333] text-gray-500 hover:text-black dark:hover:text-white text-[10px] font-bold uppercase font-mono transition-all">Cancel</button>
                <button id="modal-confirm-btn" class="flex-1 py-3 bg-black dark:bg-white text-white dark:text-black text-[10px] font-bold uppercase font-mono hover:opacity-90 transition-all">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "{{ url_for('admin.dashboard') }}".replace('/dashboard', '');
        let isWorkerPaused = false;
        let selectedUserId = null;
        let currentTab = 'queue';
        let histPage = 1, trackPage = 1, logPage = 1;

        const iconSun = document.getElementById('icon-sun');
        const iconMoon = document.getElementById('icon-moon');
        if (localStorage.getItem('theme') === 'light') { iconMoon.classList.add('hidden'); iconSun.classList.remove('hidden'); } 
        else { iconMoon.classList.remove('hidden'); iconSun.classList.add('hidden'); }

        function showNotification(message, type='success') {
            const container = document.getElementById('notif-container');
            const notif = document.createElement('div');
            let dotColor = 'bg-green-500 shadow-glow-green';
            let barColor = '#22c55e';
            let borderClass = 'border-green-500/30';
            if (type === 'error') { dotColor = 'bg-red-500 shadow-glow-red'; barColor = '#ef4444'; borderClass = 'border-red-500/30'; }
            notif.className = `w-80 bg-white dark:bg-[#0A0A0A] border ${borderClass} p-4 shadow-xl mb-4 relative overflow-hidden animate-[slideIn_0.3s_ease-out]`;
            notif.innerHTML = `<div class="flex items-start gap-3 relative z-10"><div class="w-2 h-2 rounded-full ${dotColor} mt-1 flex-shrink-0"></div><div><h4 class="text-[10px] font-bold uppercase tracking-widest text-gray-500 mb-1">SYSTEM NOTIFICATION</h4><p class="text-xs font-mono font-bold text-black dark:text-white leading-tight">${message}</p></div></div><div class="absolute bottom-0 left-0 h-1 bg-gray-100 dark:bg-[#222] w-full"><div class="h-full" style="background-color: ${barColor}; animation: shrink 4s linear forwards;"></div></div>`;
            container.appendChild(notif);
            setTimeout(() => { notif.style.animation = 'fadeOut 0.5s forwards'; setTimeout(() => notif.remove(), 500); }, 4000);
        }

        let currentModalCallback = null;
        function openModal(title, desc, showInput, callback) { document.getElementById('modal-title').innerText = title; document.getElementById('modal-desc').innerText = desc; const input = document.getElementById('modal-input'); if (showInput) { input.classList.remove('hidden'); input.value = ''; input.focus(); } else { input.classList.add('hidden'); } document.getElementById('custom-modal').classList.remove('hidden'); const confirmBtn = document.getElementById('modal-confirm-btn'); const newBtn = confirmBtn.cloneNode(true); confirmBtn.parentNode.replaceChild(newBtn, confirmBtn); newBtn.onclick = () => { const val = showInput ? input.value : true; if (showInput && !val) { input.classList.add('border-red-500'); return; } closeModal(); if (callback) callback(val); }; }
        function closeModal() { document.getElementById('custom-modal').classList.add('hidden'); document.getElementById('modal-input').classList.remove('border-red-500'); }
        function openConfirm(title, desc, callback) { openModal(title, desc, false, callback); }
        function openPrompt(title, desc, callback) { openModal(title, desc, true, callback); }
        
        // --- FIXED PROMPT LOGIC ---
        function promptReasonAndExec(action, extra, title, valueIsDirect=false) { 
            openPrompt(title.toUpperCase(), "Please input value below:", (val) => { 
                if(!val) return; 
                
                if (valueIsDirect) { 
                    if(action==='reset_pass') extra.new_password = val; 
                    if(action==='grant_sub') extra.days = val; 
                } else { 
                    extra.reason = val; 
                } 
                
                // IMPORTANT: Ensure amount comes from input field, NOT prompt
                if(action === 'update_balance') {
                    const inputAmount = parseFloat(document.getElementById('balance-adj-amount').value);
                    if(isNaN(inputAmount) || inputAmount <= 0) {
                        alert("Invalid Amount"); return;
                    }
                    extra.amount = inputAmount * (extra.amount < 0 ? -1 : 1);
                }

                userAction(action, extra); 
            }); 
        }
        
        function refundBatch(bid) { openConfirm('REFUND BATCH', `Refund Batch ${bid}? This cannot be undone.`, () => { openPrompt('REFUND REASON', 'Enter reason for audit log:', (reason) => { fetch(`${API_BASE}/api/jobs/action`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({batch_id:bid, action:'refund', reason: reason}) }).then(r => r.json()).then(data => { if(data.status === 'success') { showNotification(data.message || 'BATCH REFUNDED', 'success'); fetchHistory(); } }); }); }); }
        
        function switchTab(t) { ['queue','confirming','history','tracking','users','logs','server_errors','autoconfig','versioning'].forEach(x => { const el = document.getElementById('tab-'+x+'-content'); const btn = document.getElementById('btn-'+x); if(el) el.classList.add('hidden-section'); if(btn) { btn.classList.remove('active', 'border-black', 'dark:border-white', 'text-black', 'dark:text-white', 'border-purple-500', 'text-purple-500'); btn.classList.add('text-gray-400', 'border-transparent'); } }); document.getElementById('tab-'+t+'-content').classList.remove('hidden-section'); const activeBtn = document.getElementById('btn-'+t); 
        
        if (t === 'versioning') {
            activeBtn.classList.add('active', 'border-purple-500', 'text-purple-500');
        } else {
            activeBtn.classList.add('active', 'border-black', 'dark:border-white', 'text-black', 'dark:text-white'); 
        }
        
        activeBtn.classList.remove('text-gray-400', 'border-transparent'); currentTab = t; if(t==='queue') fetchJobs(); if(t==='confirming') fetchConfirming(); if(t==='history') fetchHistory(); if(t==='tracking') fetchTracking(); if(t==='users') searchUsers(); if(t==='logs') fetchLogs(); if(t==='server_errors') fetchServerErrors(); if(t==='autoconfig') fetchAutoConfig(); if(t==='versioning') fetchVersionConfig(); }
        
        async function fetchSystemState() { try { const res = await fetch(`${API_BASE}/api/system/health`); const data = await res.json(); const statusEl = document.getElementById('worker-state'); const pulseEl = document.getElementById('worker-pulse'); if (data.worker_status === 'PAUSED') { statusEl.innerText = "PAUSED"; statusEl.classList.replace('text-black', 'text-yellow-500'); statusEl.classList.replace('dark:text-white', 'text-yellow-500'); pulseEl.classList.replace('bg-green-500', 'bg-yellow-500'); document.getElementById('btn-pause').innerText = "RESUME"; isWorkerPaused = true; } else { statusEl.innerText = "ONLINE"; statusEl.classList.remove('text-yellow-500'); pulseEl.classList.replace('bg-yellow-500', 'bg-green-500'); document.getElementById('btn-pause').innerText = "PAUSE"; isWorkerPaused = false; } document.getElementById('queue-count').innerText = data.queue_depth; document.getElementById('error-count').innerText = data.errors_24h; document.getElementById('rev-life').innerText = "$" + parseFloat(data.revenue_lifetime).toFixed(2); document.getElementById('rev-30d').innerText = "$" + parseFloat(data.revenue_30d).toFixed(2); document.getElementById('rev-est-30d').innerText = "$" + parseFloat(data.revenue_est_30d).toFixed(2); document.getElementById('subs-mrr').innerText = "$" + parseFloat(data.subs_mrr).toFixed(2); document.getElementById('subs-count').innerText = data.subs_count; const hbDisplay = document.getElementById('hb-display'); const hbDot = document.getElementById('hb-dot'); if (data.last_heartbeat) { const last = new Date(data.last_heartbeat.replace(' ', 'T') + 'Z'); const diff = Math.round((new Date() - last) / 1000); if (diff > 60) { hbDisplay.innerText = "OFFLINE (>60s)"; hbDisplay.classList.add('text-red-500'); hbDot.classList.replace('bg-green-500', 'bg-red-500'); } else { hbDisplay.innerText = diff + "s LATENCY"; hbDisplay.classList.remove('text-red-500'); hbDot.classList.replace('bg-red-500', 'bg-green-500'); } } } catch(e) {} }
        async function fetchJobs() { if(currentTab !== 'queue') return; const res = await fetch(`${API_BASE}/api/jobs/live`); const data = await res.json(); const tbody = document.getElementById('live-queue-body'); if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400 text-[10px] tracking-widest uppercase">IDLE</td></tr>'; return; } let html = ''; data.forEach(job => { html += `<tr class="hover:bg-gray-50 dark:hover:bg-[#111] border-b border-gray-100 dark:border-[#151515] last:border-0"><td class="p-4 font-bold text-black dark:text-white">${job.id}</td><td class="p-4 text-gray-500">${job.user}</td><td class="p-4 text-gray-400">${job.date}</td><td class="p-4 text-center font-bold text-black dark:text-white">${job.size}</td><td class="p-4 text-center text-blue-500 font-bold tracking-wider">${job.status}</td></tr>`; }); tbody.innerHTML = html; }
        async function fetchConfirming() { if(currentTab !== 'confirming') return; const res = await fetch(`${API_BASE}/api/jobs/confirming`); const data = await res.json(); const tbody = document.getElementById('live-confirming-body'); if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400 text-[10px] tracking-widest uppercase">NO ACTIVE CONFIRMATIONS</td></tr>'; return; } let html = ''; data.forEach(job => { html += `<tr class="hover:bg-gray-50 dark:hover:bg-[#111] border-b border-gray-100 dark:border-[#151515]"><td class="p-4 text-blue-500 font-bold font-mono">${job.id}</td><td class="p-4 text-gray-500">${job.user}</td><td class="p-4 text-gray-400">${job.date}</td><td class="p-4 text-center font-bold text-black dark:text-white">${job.progress} / ${job.size}</td><td class="p-4 text-center text-blue-500 animate-pulse font-bold tracking-wider">CONFIRMING...</td></tr>`; }); tbody.innerHTML = html; }
        async function fetchHistory() { if(currentTab !== 'history') return; const q = document.getElementById('hist-search').value; const res = await fetch(`${API_BASE}/api/jobs/history?page=${histPage}&search=${q}`); const json = await res.json(); const tbody = document.getElementById('history-body'); document.getElementById('hist-page-info').innerText = `PAGE ${json.current_page} OF ${json.total_pages||1}`; let html = ''; if(json.data.length===0) html='<tr><td colspan="7" class="p-8 text-center text-gray-400 text-[10px] tracking-widest uppercase">EMPTY</td></tr>'; else json.data.forEach(j => { let btn = j.status==='REFUNDED' ? '<span class="text-red-500 text-[9px] font-bold">REFUNDED</span>' : `<button onclick="refundBatch('${j.id}')" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 border border-red-200 dark:border-red-900/50 px-2 py-1 text-[9px] font-bold uppercase transition-all">REFUND</button>`; html+=`<tr class="hover:bg-gray-50 dark:hover:bg-[#111] border-b border-gray-100 dark:border-[#151515]"><td class="p-4 font-mono">${j.id}</td><td class="p-4 font-bold text-black dark:text-white">${j.user}</td><td class="p-4 text-gray-400">${j.date}</td><td class="p-4 text-center font-mono">${j.progress}</td><td class="p-4 text-center text-green-600 dark:text-green-500 font-mono">$${j.value.toFixed(2)}</td><td class="p-4 text-center text-[9px] font-bold tracking-wide text-gray-500">${j.status}</td><td class="p-4 text-right">${btn}</td></tr>`; }); tbody.innerHTML = html; }
        
        async function fetchTracking() { 
            if(currentTab !== 'tracking') return; 
            const q = document.getElementById('track-search').value; 
            // --- NEW: PREFIX FILTER ---
            const prefix = document.getElementById('track-prefix').value;
            const res = await fetch(`${API_BASE}/api/tracking/list?page=${trackPage}&search=${q}&prefix=${prefix}`); 
            const json = await res.json(); 
            const tbody = document.getElementById('tracking-body'); 
            let html = ''; 
            if(json.data.length===0) html='<tr><td colspan="3" class="p-8 text-center text-gray-400 text-[10px] tracking-widest uppercase">NO DATA FOUND</td></tr>'; 
            else json.data.forEach(r => { 
                html+=`<tr class="hover:bg-gray-50 dark:hover:bg-[#111] border-b border-gray-100 dark:border-[#151515]"><td class="p-4 font-mono text-black dark:text-white">${r.tracking}</td><td class="p-4 text-gray-500 font-bold">${r.user}</td><td class="p-4 text-right text-gray-400">${r.date}</td></tr>`; 
            }); 
            tbody.innerHTML = html; 
        }
        
        async function fetchLogs() { if(currentTab !== 'logs') return; const limit = document.getElementById('logs-limit').value; const res = await fetch(`${API_BASE}/api/logs?page=${logPage}&limit=${limit}`); const data = await res.json(); const tbody = document.getElementById('logs-body'); document.getElementById('logs-page-info').innerText = `PAGE ${data.pagination.current_page} OF ${data.pagination.total_pages || 1}`; let html = ''; data.data.forEach(l => { let color = 'text-gray-500'; if(l.action === 'REFUND' || l.action.includes('REVOKE')) color = 'text-red-500'; if(l.action === 'BALANCE_ADJUST') color = 'text-green-600 dark:text-green-500'; if(l.action === 'CONFIG_UPDATE') color = 'text-purple-500'; html += `<tr class="hover:bg-gray-50 dark:hover:bg-[#111] border-b border-gray-100 dark:border-[#151515]"><td class="p-4 text-gray-400 font-mono">${l.date}</td><td class="p-4 font-bold text-[10px] tracking-wider ${color}">${l.action}</td><td class="p-4 text-black dark:text-white">${l.details}</td></tr>`; }); tbody.innerHTML = html || '<tr><td colspan="3" class="p-8 text-center text-gray-400 text-[10px] tracking-widest uppercase">NO LOGS FOUND</td></tr>'; }
        function resetLogs() { logPage = 1; fetchLogs(); }
        function changeLogPage(d) { logPage += d; if(logPage < 1) logPage = 1; fetchLogs(); }
        async function fetchServerErrors() { if(currentTab !== 'server_errors') return; const res = await fetch(`${API_BASE}/api/server/errors`); const data = await res.json(); const tbody = document.getElementById('server-errors-body'); let html = ''; data.forEach(e => { html += `<tr class="hover:bg-gray-50 dark:hover:bg-[#111] border-b border-gray-100 dark:border-[#151515] group"><td class="p-4 text-gray-400 font-mono">${e.date}</td><td class="p-4 text-yellow-600 dark:text-yellow-500 font-bold uppercase text-[10px]">${e.source}</td><td class="p-4 text-blue-500 font-mono">${e.batch || '--'}</td><td class="p-4 text-red-500 font-mono text-[10px] whitespace-pre-wrap break-all">${e.msg}</td></tr>`; }); tbody.innerHTML = html || '<tr><td colspan="4" class="p-8 text-center text-gray-400 text-[10px] tracking-widest uppercase">NO SYSTEM ERRORS RECORDED</td></tr>'; }
        async function fetchAutoConfig() { const res = await fetch(`${API_BASE}/api/automation/config`); const data = await res.json(); document.getElementById('cfg_price_monthly').value = data.automation_price_monthly || ''; document.getElementById('cfg_price_lifetime').value = data.automation_price_lifetime || ''; document.getElementById('cfg_slots_monthly').value = data.slots_monthly_total || ''; document.getElementById('cfg_slots_lifetime').value = data.slots_lifetime_total || ''; }
        async function saveAutoConfig() { const payload = { automation_price_monthly: document.getElementById('cfg_price_monthly').value, automation_price_lifetime: document.getElementById('cfg_price_lifetime').value, slots_monthly_total: document.getElementById('cfg_slots_monthly').value, slots_lifetime_total: document.getElementById('cfg_slots_lifetime').value }; const res = await fetch(`${API_BASE}/api/automation/config`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }); if(res.ok) { const data = await res.json(); showNotification(data.message || "CONFIG SAVED", "success"); } else { showNotification("ERROR SAVING CONFIG", "error"); } }
        function exportCsv() { const d = document.getElementById('export-days').value; window.location.href = `${API_BASE}/api/tracking/export?days=${d}`; showNotification(`DOWNLOADING CSV (${d} DAYS)...`, 'success'); }
        function changeHistPage(d) { histPage += d; if(histPage<1) histPage=1; fetchHistory(); }
        async function toggleWorker() { const action = isWorkerPaused ? 'resume' : 'pause'; await fetch(`${API_BASE}/api/queue/control`, {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({action})}); fetchSystemState(); }
        let userSearchTimeout;
        async function searchUsers() { const q = document.getElementById('user-search').value; const container = document.getElementById('user-list-container'); const countLabel = document.getElementById('total-users-count'); clearTimeout(userSearchTimeout); userSearchTimeout = setTimeout(async()=>{ const res = await fetch(`${API_BASE}/api/users/search?q=${q}`); const data = await res.json(); if(countLabel) countLabel.innerText = data.total; if(data.users.length === 0) { container.innerHTML = '<div class="p-4 text-center text-gray-400 text-[10px] uppercase">No Users Found</div>'; return; } let html = ''; data.users.forEach(u => { const activeClass = (selectedUserId == u.id) ? 'bg-gray-100 dark:bg-[#111] border-l-2 border-black dark:border-white' : 'border-l-2 border-transparent'; html += `<div onclick="loadUser('${u.id}', '${u.username}', '${u.balance}')" class="p-3 border-b border-gray-100 dark:border-[#151515] hover:bg-gray-50 dark:hover:bg-[#111] cursor-pointer group ${activeClass} transition-all"><div class="flex justify-between items-center"><span class="text-xs text-black dark:text-gray-300 font-bold group-hover:text-black dark:group-hover:text-white">${u.username}</span><span class="text-[10px] text-green-600 dark:text-green-500 font-mono">$${parseFloat(u.balance).toFixed(2)}</span></div><div class="text-[9px] text-gray-400 font-mono mt-1">ID: ${u.id} | Joined: ${u.date}</div></div>`; }); container.innerHTML = html; }, 300); }
        
        // --- UPDATED LOAD USER ---
        async function loadUser(id, name, bal) { 
            selectedUserId = id; 
            searchUsers(); 
            document.getElementById('user-details-empty').classList.add('hidden'); 
            document.getElementById('user-details-content').classList.remove('hidden'); 
            document.getElementById('user-details-content').classList.add('flex'); 
            document.getElementById('sel-username').innerText = name; 
            document.getElementById('sel-balance').innerText = '$'+parseFloat(bal).toFixed(2); 
            
            const res = await fetch(`${API_BASE}/api/users/details/${id}`); 
            const d = await res.json(); 
            document.getElementById('sel-ip').innerText = d.ip; 
            document.getElementById('sel-sub-status').innerText = d.subscription.is_active ? "ACTIVE" : "INACTIVE"; 
            document.getElementById('sel-sub-status').className = d.subscription.is_active ? "text-green-500 font-bold" : "text-gray-500"; 
            
            // Populate ALL price fields (95055, 94888, 94019, 95888, 91149, 93055)
            document.getElementById('price-priority-95055').value = d.prices['priority_95055'] || d.prices['priority'];
            document.getElementById('price-priority-94888').value = d.prices['priority_94888'] || d.prices['priority'];
            document.getElementById('price-priority-94019').value = d.prices['priority_94019'] || d.prices['priority'];
            document.getElementById('price-priority-95888').value = d.prices['priority_95888'] || d.prices['priority'];
            document.getElementById('price-priority-91149').value = d.prices['priority_91149'] || d.prices['priority'];
            document.getElementById('price-priority-93055').value = d.prices['priority_93055'] || d.prices['priority'];
            
            const rev = document.getElementById('btn-revoke-sub'); 
            if(d.subscription.is_active) rev.classList.remove('hidden'); else rev.classList.add('hidden'); 
        }
        
        async function userAction(act, extra={}) { 
            if(!selectedUserId) return; 
            let payload = {action:act, user_id:selectedUserId, ...extra}; 
            
            if(act === 'update_price') { 
                // Dynamically grab price from specific input
                payload.price = document.getElementById('price-priority-'+extra.version).value; 
                payload.label_type = extra.type; 
            } 
            
            const res = await fetch(`${API_BASE}/api/users/action`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) }); 
            if(res.ok) { 
                const data = await res.json(); 
                showNotification(data.message || "ACTION COMPLETED", "success"); 
                if(act==='update_balance') { 
                    document.getElementById('sel-balance').innerText = '$' + parseFloat(data.new_balance || 0).toFixed(2); 
                    document.getElementById('balance-adj-amount').value = ''; 
                    searchUsers(); 
                } 
                if(act==='revoke_sub' || act==='grant_sub') loadUser(selectedUserId, document.getElementById('sel-username').innerText, document.getElementById('sel-balance').innerText.replace('$','')); 
            } else { 
                showNotification("ACTION FAILED", "error"); 
            } 
        }

        // --- NEW: VERSION CONTROL FUNCTIONS (REDESIGNED) ---
        async function fetchVersionConfig() {
            try {
                const res = await fetch(`${API_BASE}/api/versions/config`);
                const data = await res.json();
                const grid = document.getElementById('version-grid');
                let html = '';
                
                Object.keys(data).forEach(ver => {
                    const info = data[ver];
                    const isEnabled = info.enabled;
                    
                    // --- STYLING VARS ---
                    let statusDot = isEnabled ? 'bg-green-500' : 'bg-red-500';
                    let statusText = isEnabled ? 'ONLINE' : 'DISABLED';
                    let statusColor = isEnabled ? 'text-green-500' : 'text-red-500';
                    let btnColor = isEnabled ? 'text-red-500 border-red-500/20 hover:bg-red-500/10' : 'text-green-500 border-green-500/20 hover:bg-green-500/10';
                    let btnText = isEnabled ? 'DEACTIVATE' : 'ACTIVATE';

                    // --- LABELS ---
                    let label = '';
                    if (ver === '95055') label = 'STANDARD';
                    else if (ver === '94888') label = 'LEGACY';
                    else label = 'TEST';

                    let labelColor = (label === 'TEST') ? 'text-purple-500 bg-purple-500/10 border-purple-500/20' : 
                                    (label === 'LEGACY') ? 'text-yellow-500 bg-yellow-500/10 border-yellow-500/20' : 
                                    'text-blue-500 bg-blue-500/10 border-blue-500/20';

                    html += `
                    <div class="bg-white dark:bg-[#0A0A0A] border border-gray-200 dark:border-[#1E1E1E] p-6 shadow-sm relative group hover:border-gray-400 dark:hover:border-gray-600 transition-all">
                        <div class="absolute top-4 right-4 px-2 py-0.5 border ${labelColor} rounded text-[8px] font-bold uppercase font-mono">
                            ${label}
                        </div>

                        <div class="mb-6">
                            <h3 class="text-3xl font-black text-black dark:text-white font-mono tracking-tighter mb-1">${ver}</h3>
                            <div class="flex items-center gap-2">
                                <div class="w-1.5 h-1.5 rounded-full ${statusDot}"></div>
                                <p class="text-[9px] font-bold ${statusColor} font-mono uppercase tracking-widest">${statusText}</p>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="text-[8px] font-bold text-gray-400 uppercase tracking-widest mb-1 block">Global Base Price</label>
                            <div class="flex">
                                <span class="p-3 bg-gray-50 dark:bg-[#111] border border-r-0 border-gray-200 dark:border-[#333] text-xs font-mono text-gray-500">$</span>
                                <input type="number" id="v_price_${ver}" value="${info.price.toFixed(2)}" class="w-full p-3 bg-white dark:bg-black border border-gray-200 dark:border-[#333] text-xs font-bold font-mono text-black dark:text-white outline-none focus:border-black dark:focus:border-white">
                                <button onclick="updateGlobalPrice('${ver}')" class="px-4 bg-black dark:bg-white text-white dark:text-black text-[9px] font-bold uppercase hover:opacity-80 transition-all font-mono">
                                    SAVE
                                </button>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-100 dark:border-[#151515]">
                            <button onclick="toggleVersion('${ver}', ${!isEnabled})" class="w-full py-3 border ${btnColor} text-[9px] font-bold uppercase transition-all font-mono">
                                ${btnText}
                            </button>
                        </div>
                    </div>`;
                });
                grid.innerHTML = html;
            } catch(e) { console.error(e); }
        }

        async function toggleVersion(ver, newState) {
            try {
                const res = await fetch(`${API_BASE}/api/versions/config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'toggle_status', version: ver, enabled: newState })
                });
                if(res.ok) {
                    showNotification(`VERSION ${ver} ${newState ? 'ENABLED' : 'DISABLED'}`, 'success');
                    fetchVersionConfig();
                }
            } catch(e) { showNotification("FAILED TO UPDATE STATUS", "error"); }
        }

        async function updateGlobalPrice(ver) {
            const price = document.getElementById(`v_price_${ver}`).value;
            openConfirm("UPDATE GLOBAL PRICING", `Set ${ver} to $${price} for ALL users? This overwrites individual settings.`, async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/versions/config`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action: 'bulk_price', version: ver, price: price })
                    });
                    if(res.ok) {
                        showNotification(`PRICE UPDATED FOR ALL USERS`, 'success');
                        fetchVersionConfig();
                    }
                } catch(e) { showNotification("UPDATE FAILED", "error"); }
            });
        }

        setInterval(() => { fetchSystemState(); if(currentTab==='queue') fetchJobs(); if(currentTab==='confirming') fetchConfirming(); }, 2000);
        switchTab('queue'); // Init default
        fetchSystemState();
    </script>
</body>
</html>